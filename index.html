<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shotcrete Calc</title>

  <!-- ‚úÖ Canonical -->
  <link rel="canonical" href="https://clauramarcelo.github.io/shotcrete-calc/" />

  <!-- ‚úÖ Manifest PWA -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json" />
  <meta name="theme-color" content="#ff6a00" />

  <!-- ‚úÖ Apple PWA -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="/shotcrete-calc/icon-192.png" />

  <style>
    :root{
      --brand:#ff6a00;
      --brand-2:#ff821a;
      --bg:#ffffff; --fg:#0b0b0b; --muted:#667085; --card:#f6f8fa; --border:#d0d5dd;
      color-scheme: light dark;

      --plomo-avance-bg: #f3f4f6;
      --plomo-avance-br: #d0d5dd;
      --plomo-bandas-bg: #f1f5f9;
      --plomo-bandas-br: #cbd5e1;
      --plomo-resanes-bg: #f7f3f2;
      --plomo-resanes-br: #e0d6d3;
      --plomo-b1-bg: #eef2f7;
      --plomo-b2-bg: #eff6f4;
      --plomo-b3-bg: #f5f2f8;
      --accent-soft: rgba(255,106,0,0.35);
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0b; --fg:#eee; --muted:#98a2b3; --card:#14171a; --border:#2a2e33;
        --plomo-avance-bg: rgba(255,255,255,0.06);
        --plomo-avance-br: rgba(255,255,255,0.14);
        --plomo-bandas-bg: rgba(120,160,255,0.08);
        --plomo-bandas-br: rgba(170,190,255,0.18);
        --plomo-resanes-bg: rgba(255,210,180,0.06);
        --plomo-resanes-br: rgba(255,210,180,0.16);
        --plomo-b1-bg: rgba(255,255,255,0.05);
        --plomo-b2-bg: rgba(180,255,230,0.06);
        --plomo-b3-bg: rgba(220,190,255,0.06);
        --accent-soft: rgba(255,106,0,0.42);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.35;
      padding-bottom:env(safe-area-inset-bottom)
    }
    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff;
      padding:calc(.6rem + env(safe-area-inset-top)) 1rem .6rem 1rem;
      display:flex;align-items:center;justify-content:space-between;gap:.75rem;
      box-shadow:0 2px 12px rgba(0,0,0,.12)
    }
    header .left{display:flex;align-items:center;gap:.75rem}
    header .logo{width:28px;height:28px;border-radius:6px;background:#fff2;display:inline-block}
    header h1{margin:0;font-size:1.1rem}
    #netBadge{
      font-size:.85rem;
      padding:.25rem .55rem;
      border-radius:999px;
      background:rgba(255,255,255,0.22);
      border:1px solid rgba(255,255,255,0.30);
      white-space:nowrap;
    }

    main{max-width:960px;margin:0 auto;padding:1rem;padding-bottom:4.5rem}
    fieldset{
      border:1px solid var(--border);
      border-radius:.8rem;
      background:var(--card);
      padding:1rem;margin:0 0 1rem
    }
    legend{font-weight:700;padding:0 .5rem}
    label{display:block;margin:.55rem 0 .25rem}
    input,select{
      width:100%;padding:.65rem .75rem;font-size:1rem;
      border:1px solid var(--border);
      border-radius:.6rem;background:#fff;outline:none
    }
    @media (prefers-color-scheme: dark){
      input,select{background:#0e0e10;color:var(--fg)}
    }

    /* ‚úÖ Layout responsivo */
    .row2c{display:grid;grid-template-columns:1fr 1fr;gap:.7rem}
    @media (max-width:360px){ .row2c{grid-template-columns:1fr;} }
    .row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
    @media (max-width:820px){ .row3{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row3{grid-template-columns:1fr} .row2{grid-template-columns:1fr} }
    .span2{ grid-column: 1 / -1; }

    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.8rem;align-items:center}

    /* ‚úÖ Botones amigables */
    .btn{
      border:none;border-radius:.7rem;padding:.85rem 1rem;font-size:1rem;
      display:inline-flex;align-items:center;justify-content:center;gap:.5rem;cursor:pointer;
      min-width: 140px;
    }
    @media (max-width:480px){
      .btn{flex:1; min-width:0;}
    }
    .btn.primary{background:var(--brand);color:#fff}
    .btn.secondary{background:#f28c2a;color:#fff}
    .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}
    .btn.tiny{
      padding:.45rem .65rem;
      font-size:.9rem;
      min-width: auto;
      border-radius:.55rem;
    }
    @media (max-width:480px){
      .btn.tiny{flex:0; }
    }

    .result{
      margin-top:.9rem;padding:1rem;border-radius:.8rem;background:#fff;
      border:1px dashed var(--border);
      display:flex;align-items:center;justify-content:center;text-align:center;
      flex-direction:column; gap:.35rem;
    }
    @media (prefers-color-scheme: dark){ .result{background:#0e0e10} }
    .result h2{margin:0;font-size:clamp(1.4rem,4vw,2.1rem);font-weight:800;color:var(--brand)}
    .result small{display:block;color:var(--muted);margin-top:.15rem;white-space:pre-line}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.55rem;text-align:left;vertical-align:top}
    thead th{background:#fff3e8}
    @media (prefers-color-scheme: dark){
      thead th{background:#24170a;color:#fed8b4}
    }
    .mini-table th,.mini-table td{padding:.45rem;font-size:.95rem}

    /* ‚úÖ MEJORA CLAVE: tablas amigables en m√≥vil */
    .table-wrap{
      overflow-x:auto;
      -webkit-overflow-scrolling: touch;
      border:1px solid var(--border);
      border-radius:.8rem;
      background:rgba(255,255,255,0.25);
    }
    @media (prefers-color-scheme: dark){
      .table-wrap{background:rgba(0,0,0,0.10)}
    }
    /* ayuda a que no ‚Äúapriete‚Äù columnas */
    .table-wrap table{ min-width: 860px; }
    @media (max-width:480px){
      .table-wrap table{ min-width: 980px; } /* m√°s espacio para scroll en tel√©fono */
    }
    /* hint visual de scroll */
    .scroll-hint{
      margin-top:.45rem;
      font-size:.9rem;
      color:var(--muted);
    }

    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:9999;
      background:var(--bg);
      border-top:1px solid var(--border);
      padding:.35rem calc(.6rem + env(safe-area-inset-bottom)) .35rem .6rem;
      display:grid;grid-template-columns:repeat(3,1fr);gap:.25rem
    }
    .tabbar button{
      appearance:none;border:none;background:transparent;color:#667085;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:.25rem;padding:.5rem 0;border-radius:.5rem;cursor:pointer;font-size:.9rem
    }
    .tabbar button.active{color:var(--brand);font-weight:700;background:#fff7ef}
    @media (prefers-color-scheme: dark){ .tabbar button.active{background:#1b140c} }

    section.tab{display:none}
    section.tab.active{display:block}
    .hidden{display:none !important}

    .checkline{
      display:inline-flex; align-items:center; gap:.45rem;
      user-select:none;
      padding:.35rem .55rem;
      border:1px solid var(--border);
      border-radius:.55rem;
      background:rgba(255,255,255,0.55);
    }
    @media (prefers-color-scheme: dark){ .checkline{background:rgba(0,0,0,0.18)} }
    .checkline input{width:auto;margin:0;transform:scale(1.05)}

    .pane{
      margin-top:.75rem;
      padding:.75rem;
      border:1px solid var(--border);
      border-radius:.7rem;
      background:rgba(255,255,255,0.55);
    }
    .pane-title{font-weight:800;margin:.1rem 0 .4rem}
    .pane.pane-avance{
      background: var(--plomo-avance-bg);
      border-color: var(--plomo-avance-br);
      box-shadow: inset 3px 0 0 var(--accent-soft);
    }
    .pane.pane-bandas{
      background: var(--plomo-bandas-bg);
      border-color: var(--plomo-bandas-br);
      box-shadow: inset 3px 0 0 var(--accent-soft);
    }
    .pane.pane-resanes{
      background: var(--plomo-resanes-bg);
      border-color: var(--plomo-resanes-br);
      box-shadow: inset 3px 0 0 var(--accent-soft);
    }
    .subpane{
      border:1px solid var(--border);
      border-radius:.7rem;
      padding:.65rem;
      margin-top:.6rem;
      background: rgba(255,255,255,0.35);
    }
    .subpane-title{font-weight:800;margin:0 0 .35rem}
    .subpane.sub-b1{ background: rgba(255,255,255,0.06); }
    .subpane.sub-b2{ background: rgba(255,255,255,0.06); }
    .subpane.sub-b3{ background: rgba(255,255,255,0.06); }

    .bandsGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:.7rem;
      margin-top:.6rem;
    }
    @media (max-width:360px){ .bandsGrid{grid-template-columns:1fr;} }

    .muted{color:var(--muted);font-size:.95rem}
    .no-print{}

    /* Loader */
    #appLoader{
      position:fixed; inset:0; z-index:99999;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, #fdf7f3, #fff2e5);
      transition:opacity .35s ease, visibility .35s ease;
    }
    @media (prefers-color-scheme: dark){
      #appLoader{ background:linear-gradient(180deg, #0f0c08, #140f0a); }
    }
    #appLoader.hidden{ opacity:0; visibility:hidden; }
    .loader-card{
      width:min(280px, 70vw);
      padding:28px 24px;
      border-radius:24px;
      background:rgba(255,255,255,0.88);
      box-shadow:0 12px 40px rgba(0,0,0,.18);
      display:flex; flex-direction:column;
      align-items:center; gap:16px;
      backdrop-filter:saturate(140%) blur(6px);
      border:1px solid #ffd2ad;
    }
    @media (prefers-color-scheme: dark){
      .loader-card{
        background:rgba(22,24,28,0.84);
        box-shadow:0 12px 40px rgba(0,0,0,.42);
        border-color:#3a2a18;
      }
    }
    .loader-icon{
      width:84px; height:84px;
      object-fit:cover; border-radius:18px;
      box-shadow:0 6px 16px rgba(0,0,0,.18);
      transform:scale(.96);
      animation:pop .5s cubic-bezier(.2,.8,.2,1) .1s both;
      border:2px solid #fff6;
    }
    @keyframes pop{ from{ transform:scale(.92); opacity:.6; } to{ transform:scale(1.00); opacity:1; } }
    .loader-spinner{
      width:34px; height:34px; border-radius:50%;
      border:3px solid rgba(120,120,120,.28);
      border-top-color:var(--brand);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{ to { transform:rotate(360deg); } }
    .loader-text{
      font:500 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#333; letter-spacing:.2px;
    }
    @media (prefers-color-scheme: dark){ .loader-text{ color:#d8d8d8; } }

    /* ===================== MODO IMPRESI√ìN ===================== */
    #printArea { display:none; }
    @media print {
      header, .tabbar, #appLoader { display:none !important; }
      main { display:none !important; }
      #printArea { display:block !important; }
      body { background:#fff !important; color:#000 !important; }
      .table-wrap{ overflow: visible !important; border: none !important; } /* no estorba al PDF */
    }
    #printArea{
      padding:18px 18px 0 18px;
      font-family: Arial, Helvetica, sans-serif;
      color:#111;
    }
    #printArea h2{
      margin:0 0 6px;
      font-size:16px;
      text-transform:uppercase;
    }
    #printMeta{
      font-size:11px;
      color:#333;
      margin:0 0 10px;
      white-space:pre-line;
    }
    #printSums{
      font-size:12px;
      margin:0 0 12px;
    }
    #printChartWrap canvas{
      width:100% !important;
      height:auto !important;
      max-width:100%;
      border:1px solid #ddd;
    }
    #printTableWrap table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    #printTableWrap th, #printTableWrap td{
      border:1px solid #333;
      padding:6px;
      vertical-align:top;
    }
    #printTableWrap thead th{
      background:#f2f2f2;
    }
  </style>
</head>

<body>
  <header>
    <div class="left">
      <span class="logo" aria-hidden="true"></span>
      <h1>Shotcrete Calc</h1>
    </div>
    <div id="netBadge">‚è≥</div>
  </header>

  <!-- Loader local -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <img class="loader-icon" src="/shotcrete-calc/icon-192.png" alt="Logo" />
      <div class="loader-spinner" aria-label="Cargando"></div>
      <div class="loader-text">Cargando‚Ä¶</div>
    </div>
  </div>

  <main>
    <!-- ================= CALCULO m3 ================= -->
    <section id="tab-calculo" class="tab active" aria-labelledby="btn-calculo">
      <fieldset>
        <legend>Calculo m3</legend>

        <div class="actions" style="margin-bottom:.35rem">
          <label class="checkline"><input id="chkAvance" type="checkbox" />Avance + Frente de sacrificio</label>
          <label class="checkline"><input id="chkBandas" type="checkbox" />Calc. Bandas</label>
          <label class="checkline"><input id="chkResane" type="checkbox" />Calc. Resanes</label>
        </div>

        <div id="paneAvance" class="pane pane-avance hidden">
          <div class="pane-title">Avance + Frente de sacrificio</div>
          <div class="row3">
            <div><label for="aA">Ancho (A) ‚Äî m</label><input id="aA" type="text" inputmode="decimal"></div>
            <div><label for="aH">Altura (H) ‚Äî m</label><input id="aH" type="text" inputmode="decimal"></div>
            <div><label for="aL">Longitud (L) ‚Äî m</label><input id="aL" type="text" inputmode="decimal"></div>
          </div>
          <div class="row2" style="margin-top:.6rem">
            <div><label for="aSac">Frente de sacrificio ‚Äî m¬≥</label><input id="aSac" type="text" inputmode="decimal" readonly></div>
            <div><label for="aConst">Constante</label><input id="aConst" type="text" inputmode="decimal" value="11.5"></div>
          </div>
        </div>

        <div id="paneBandas" class="pane pane-bandas hidden">
          <div class="pane-title">Calc. Bandas</div>

          <div class="subpane sub-b1">
            <div class="subpane-title">Banda 1</div>
            <div class="row3">
              <div><label for="b1A">Ancho (A) ‚Äî m</label><input id="b1A" type="text" inputmode="decimal"></div>
              <div><label for="b1H">Altura (H) ‚Äî m</label><input id="b1H" type="text" inputmode="decimal"></div>
              <div><label for="b1L">Longitud (L) ‚Äî m</label><input id="b1L" type="text" inputmode="decimal"></div>
            </div>
          </div>

          <div class="subpane sub-b2">
            <div class="subpane-title">Banda 2</div>
            <div class="row3">
              <div><label for="b2A">Ancho (A) ‚Äî m</label><input id="b2A" type="text" inputmode="decimal"></div>
              <div><label for="b2H">Altura (H) ‚Äî m</label><input id="b2H" type="text" inputmode="decimal"></div>
              <div><label for="b2L">Longitud (L) ‚Äî m</label><input id="b2L" type="text" inputmode="decimal"></div>
            </div>
          </div>

          <div class="subpane sub-b3">
            <div class="subpane-title">Banda 3</div>
            <div class="row3">
              <div><label for="b3A">Ancho (A) ‚Äî m</label><input id="b3A" type="text" inputmode="decimal"></div>
              <div><label for="b3H">Altura (H) ‚Äî m</label><input id="b3H" type="text" inputmode="decimal"></div>
              <div><label for="b3L">Longitud (L) ‚Äî m</label><input id="b3L" type="text" inputmode="decimal"></div>
            </div>
          </div>
        </div>

        <div id="paneResane" class="pane pane-resanes hidden">
          <div class="pane-title">Calc. Resanes</div>
          <div class="row2">
            <div><label for="sA">Ancho (A) ‚Äî m</label><input id="sA" type="text" inputmode="decimal"></div>
            <div><label for="sH">Altura (H) ‚Äî m</label><input id="sH" type="text" inputmode="decimal"></div>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="qCalcular" type="button">Calcular total</button>
          <button class="btn ghost" id="qLimpiar" type="button">Limpiar</button>
        </div>

        <div id="qOut" class="result" aria-live="polite">
          <h2>‚Äî</h2><small id="qMode"></small>
        </div>
      </fieldset>
    </section>

    <!-- ================= REGISTROS (LIMPIO) ================= -->
    <section id="tab-registros" class="tab" aria-labelledby="btn-registros">
      <fieldset>
        <legend>Registros</legend>

        <div class="row2c">
          <div>
            <label for="regFecha">Fecha</label>
            <input id="regFecha" type="date" />
          </div>
          <div>
            <label for="regGuardia">Guardia</label>
            <select id="regGuardia">
              <option value="" selected disabled>Selecciona‚Ä¶</option>
              <option value="D√≠a">D√≠a</option>
              <option value="Noche">Noche</option>
            </select>
          </div>
        </div>

        <div class="row2c" style="margin-top:.4rem">
          <div>
            <label for="regNivel">Nivel</label>
            <input id="regNivel" type="text" />
          </div>
          <div>
            <label for="regEjecutor">Ejecutor</label>
            <select id="regEjecutor">
              <option value="" selected disabled>Selecciona‚Ä¶</option>
              <option value="Volcan">Volcan</option>
              <option value="Iesa">Iesa</option>
            </select>
          </div>
        </div>

        <div style="margin-top:.4rem">
          <label for="regLabor">Labor</label>
          <input id="regLabor" type="text" />
        </div>

        <div class="actions" style="margin-top:.8rem">
          <label class="checkline"><input id="rChkAvance" type="checkbox" />Avance + Frente</label>
          <label class="checkline"><input id="rChkBandas" type="checkbox" />Bandas</label>
          <label class="checkline"><input id="rChkResane" type="checkbox" />Resanes</label>
        </div>

        <!-- Avance -->
        <div id="rPaneAvance" class="pane pane-avance hidden">
          <div class="pane-title">Avance + Frente de sacrificio</div>
          <div class="row2c">
            <div><label for="rAA">Ancho (A) ‚Äî m</label><input id="rAA" type="text" inputmode="decimal"></div>
            <div><label for="rAH">Altura (H) ‚Äî m</label><input id="rAH" type="text" inputmode="decimal"></div>
          </div>
          <div class="row2c" style="margin-top:.4rem">
            <div><label for="rAL">Longitud (L) ‚Äî m</label><input id="rAL" type="text" inputmode="decimal"></div>
            <div><label for="rAConst">Constante</label><input id="rAConst" type="text" inputmode="decimal" value="11.5"></div>
          </div>
          <div style="margin-top:.4rem">
            <label for="rASac">Frente de sacrificio ‚Äî m¬≥</label>
            <input id="rASac" type="text" inputmode="decimal" readonly>
          </div>
        </div>

        <!-- Bandas -->
        <div id="rPaneBandas" class="pane pane-bandas hidden">
          <div class="pane-title">Calc. Bandas</div>

          <div class="bandsGrid">
            <div class="subpane sub-b1">
              <div class="subpane-title">Banda 1</div>
              <div class="row2c">
                <div><label for="rb1A">Ancho (A)</label><input id="rb1A" type="text" inputmode="decimal"></div>
                <div><label for="rb1H">Altura (H)</label><input id="rb1H" type="text" inputmode="decimal"></div>
              </div>
              <div style="margin-top:.4rem">
                <label for="rb1L">Longitud (L)</label>
                <input id="rb1L" type="text" inputmode="decimal">
              </div>
            </div>

            <div class="subpane sub-b2">
              <div class="subpane-title">Banda 2</div>
              <div class="row2c">
                <div><label for="rb2A">Ancho (A)</label><input id="rb2A" type="text" inputmode="decimal"></div>
                <div><label for="rb2H">Altura (H)</label><input id="rb2H" type="text" inputmode="decimal"></div>
              </div>
              <div style="margin-top:.4rem">
                <label for="rb2L">Longitud (L)</label>
                <input id="rb2L" type="text" inputmode="decimal">
              </div>
            </div>

            <div class="subpane sub-b3 span2">
              <div class="subpane-title">Banda 3</div>
              <div class="row2c">
                <div><label for="rb3A">Ancho (A)</label><input id="rb3A" type="text" inputmode="decimal"></div>
                <div><label for="rb3H">Altura (H)</label><input id="rb3H" type="text" inputmode="decimal"></div>
              </div>
              <div style="margin-top:.4rem">
                <label for="rb3L">Longitud (L)</label>
                <input id="rb3L" type="text" inputmode="decimal">
              </div>
            </div>
          </div>
        </div>

        <!-- Resanes -->
        <div id="rPaneResane" class="pane pane-resanes hidden">
          <div class="pane-title">Calc. Resanes</div>
          <div class="row2c">
            <div><label for="rsA">Ancho (A) ‚Äî m</label><input id="rsA" type="text" inputmode="decimal"></div>
            <div><label for="rsH">Altura (H) ‚Äî m</label><input id="rsH" type="text" inputmode="decimal"></div>
          </div>
        </div>

        <!-- ‚úÖ SOLO 2 BOTONES -->
        <div class="actions">
          <button class="btn primary" id="rGuardar" type="button">Guardar</button>
          <button class="btn ghost" id="rLimpiar" type="button">Limpiar</button>
        </div>

        <div id="rOut" class="result" aria-live="polite">
          <h2>‚Äî</h2><small id="rOutDetail"></small>
        </div>
      </fieldset>
    </section>

    <!-- ================= REPORTE (RESPONSIVO) ================= -->
    <section id="tab-reporte" class="tab" aria-labelledby="btn-reporte">
      <fieldset>
        <legend>Reporte</legend>

        <div class="row2c" style="margin:0 0 .6rem">
          <div>
            <label for="repFecha">Fecha del reporte</label>
            <input id="repFecha" type="date" />
          </div>
          <div class="muted" style="display:flex;align-items:flex-end">
            Se listan todos los registros guardados para esa fecha (m√°x. 14).
          </div>
        </div>

        <fieldset style="margin:0 0 1rem">
          <legend>Cuadro de registro (del d√≠a)</legend>

          <div class="table-wrap">
            <table class="mini-table" id="regCuadro">
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Guardia</th>
                  <th>Labor / Nivel</th>
                  <th>Ejecutor</th>
                  <th>m¬≥ (Total)</th>
                  <th>Avance + frente</th>
                  <th>Bandas</th>
                  <th>Resanes</th>
                  <th class="no-print">Acciones</th>
                </tr>
              </thead>
              <tbody id="repDayBody"></tbody>
              <tfoot>
                <tr>
                  <th colspan="4">SUMAS DEL D√çA</th>
                  <th id="repSumTotal">‚Äî</th>
                  <th id="repSumAvance">‚Äî</th>
                  <th id="repSumBandas">‚Äî</th>
                  <th id="repSumResanes">‚Äî</th>
                  <th class="no-print">‚Äî</th>
                </tr>
              </tfoot>
            </table>
          </div>
          <div class="scroll-hint no-print">üì± Tip: Desliza la tabla hacia los lados para ver todas las columnas.</div>

          <div class="actions no-print">
            <button class="btn ghost" id="repPrint" type="button">Imprimir / Guardar PDF</button>
          </div>
        </fieldset>

        <fieldset>
          <legend>Historial (BD offline - base completa)</legend>

          <div class="actions no-print">
            <button class="btn primary" id="tblExportCSV" type="button">Exportar BD a CSV</button>
            <button class="btn ghost" id="tblRefrescar" type="button">Refrescar</button>
            <button class="btn secondary" id="tblBorrarTodo" type="button">Borrar TODO</button>
          </div>

          <div class="table-wrap">
            <table id="tblHist" class="mini-table">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Fecha</th>
                  <th>Guardia</th>
                  <th>Labor</th>
                  <th>Nivel</th>
                  <th>Ejecutor</th>
                  <th>m¬≥(Total)</th>
                  <th>Avance</th>
                  <th>Bandas</th>
                  <th>Resanes</th>
                  <th class="no-print">Acciones</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="scroll-hint no-print">üì± Tip: En Historial tambi√©n puedes deslizar horizontalmente.</div>
        </fieldset>
      </fieldset>
    </section>
  </main>

  <nav class="tabbar no-print" role="tablist" aria-label="Navegaci√≥n">
    <button type="button" id="btn-calculo" class="active" role="tab"
      aria-controls="tab-calculo" aria-selected="true"
      onclick="switchTab('tab-calculo', this)">Calculo m3</button>
    <button type="button" id="btn-registros" role="tab"
      aria-controls="tab-registros" aria-selected="false"
      onclick="switchTab('tab-registros', this)">Registros</button>
    <button type="button" id="btn-reporte" role="tab"
      aria-controls="tab-reporte" aria-selected="false"
      onclick="switchTab('tab-reporte', this)">Reporte</button>
  </nav>

  <!-- ===================== √Årea de impresi√≥n ===================== -->
  <div id="printArea">
    <h2>SHOTCRETE CALC - REPORTE DEL D√çA</h2>
    <div id="printMeta"></div>
    <div id="printSums"></div>
    <div id="printChartWrap" style="margin-top:12px;"></div>
    <div id="printTableWrap" style="margin-top:12px;"></div>
  </div>

  <script>
    // --- URL / Online badge ---
    if (location.pathname === '/shotcrete-calc') location.replace('/shotcrete-calc/');
    const netBadge = document.getElementById('netBadge');
    function updateNetBadge(){ netBadge.textContent = navigator.onLine ? 'üü¢ Online' : 'üî¥ Offline'; }
    window.addEventListener('online', updateNetBadge);
    window.addEventListener('offline', updateNetBadge);
    updateNetBadge();

    // --- Utilidades ---
    function parseDec(txt){
      if (typeof txt !== 'string') return NaN;
      const s = txt.trim().replace(',', '.');
      if (s === '') return NaN;
      return Number(s);
    }
    const fmt1 = (n) => Number(n).toFixed(1);
    const todayStr = () => new Date().toISOString().slice(0,10);
    function isFilled(v){ return String(v ?? '').trim() !== ''; }

    // --- Tabs ---
    function switchTab(targetId, btnEl){
      document.querySelectorAll('.tabbar button').forEach(b=>{
        const active = (b === btnEl);
        b.classList.toggle('active', active);
        b.setAttribute('aria-selected', active ? 'true' : 'false');
      });
      document.querySelectorAll('section.tab').forEach(sec=>{
        sec.classList.toggle('active', sec.id === targetId);
      });
      if (targetId === 'tab-reporte'){
        renderDayReport();
        renderHistDB();
      }
    }

    // --- F√≥rmulas ---
    function calcFrente(A, H){
      const hEff = Math.max(0, H - 2);
      return (A * hEff * 0.9) / 14;
    }
    function calcAvanceBase(A, H, L, C){
      const pp = (H * 2) + A;
      const pa = pp * 0.9;
      const al = pa * L;
      return al / C;
    }
    function calcBandas(A, H, L){
      return ((((H * 2) + A) * 0.9) * L) / 11.5;
    }
    function calcResane(A, H){
      return (H * A) / 11.5;
    }
    function togglePane(chk, pane){ pane.classList.toggle('hidden', !chk.checked); }

    function sumBandas3From(a1,h1,l1,a2,h2,l2,a3,h3,l3){
      let sum = 0;
      const bands = [
        {A:a1.value,H:h1.value,L:l1.value},
        {A:a2.value,H:h2.value,L:l2.value},
        {A:a3.value,H:h3.value,L:l3.value},
      ];
      for (const bx of bands){
        const any = isFilled(bx.A) || isFilled(bx.H) || isFilled(bx.L);
        if (!any) continue;
        const A=parseDec(bx.A), H=parseDec(bx.H), L=parseDec(bx.L);
        if (isFinite(A) && isFinite(H) && isFinite(L)) sum += calcBandas(A,H,L);
      }
      return sum;
    }

    // =================== BD offline (localStorage) ===================
    const LS_DB  = 'sc_db_registros';
    const LS_DAY = 'sc_day_registros';

    function safeJSONParse(key, fallback){
      try { return JSON.parse(localStorage.getItem(key)) ?? fallback; }
      catch { return fallback; }
    }
    function safeJSONSet(key, value){
      localStorage.setItem(key, JSON.stringify(value));
    }
    function getDB(){ return safeJSONParse(LS_DB, []); }
    function setDB(arr){ safeJSONSet(LS_DB, arr); }
    function getDayDB(){ return safeJSONParse(LS_DAY, {}); }
    function setDayDB(obj){ safeJSONSet(LS_DAY, obj); }

    function makeId(){
      return 'r_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2,8);
    }
    function upsertById(arr, rec){
      const idx = arr.findIndex(x => x.id === rec.id);
      if (idx >= 0) arr[idx] = rec;
      else arr.push(rec);
      return arr;
    }
    function removeById(arr, id){
      const idx = arr.findIndex(x => x.id === id);
      if (idx >= 0) arr.splice(idx, 1);
      return arr;
    }

    // Estado edici√≥n desde Historial BD
    window.__editingId = null;
    window.__editingOriginalFecha = null;

    // ‚úÖ Eliminar en ambas BD (d√≠a + historial)
    function deleteRecordEverywhere(id, fecha){
      const db = getDB();
      setDB(db.filter(r => r.id !== id));

      const dayDB = getDayDB();
      const arr = dayDB[fecha] ?? [];
      removeById(arr, id);
      dayDB[fecha] = arr;
      setDayDB(dayDB);

      if (window.__editingId === id) limpiarFormularioRegistros();

      renderHistDB();
      renderDayReport();
    }

    // ================= CALCULO m3 =================
    const chkAvance = document.getElementById('chkAvance');
    const chkBandas = document.getElementById('chkBandas');
    const chkResane = document.getElementById('chkResane');
    const paneAvance = document.getElementById('paneAvance');
    const paneBandas = document.getElementById('paneBandas');
    const paneResane = document.getElementById('paneResane');

    const aA = document.getElementById('aA');
    const aH = document.getElementById('aH');
    const aL = document.getElementById('aL');
    const aConst = document.getElementById('aConst');
    const aSac = document.getElementById('aSac');

    const b1A = document.getElementById('b1A'), b1H = document.getElementById('b1H'), b1L = document.getElementById('b1L');
    const b2A = document.getElementById('b2A'), b2H = document.getElementById('b2H'), b2L = document.getElementById('b2L');
    const b3A = document.getElementById('b3A'), b3H = document.getElementById('b3H'), b3L = document.getElementById('b3L');

    const sA = document.getElementById('sA');
    const sH = document.getElementById('sH');

    const qOutH2 = document.querySelector('#qOut h2');
    const qMode = document.getElementById('qMode');

    function calcTotalCalculo(){
      let total=0;
      const lines=[];

      if(!chkAvance.checked && !chkBandas.checked && !chkResane.checked){
        qOutH2.textContent='‚Äî'; qMode.textContent=''; aSac.value=''; return;
      }

      if(chkAvance.checked){
        const A=parseDec(aA.value), H=parseDec(aH.value), L=parseDec(aL.value), C=parseDec(aConst.value || '11.5');
        if(isFinite(A)&&isFinite(H)&&isFinite(L)&&isFinite(C)&&C>0){
          const base=calcAvanceBase(A,H,L,C);
          const sac=calcFrente(A,H);
          aSac.value=sac.toFixed(2);
          const part=base+sac; total+=part;
          lines.push(`Avance + Frente: ${fmt1(part)} m¬≥`);
        } else aSac.value='';
      } else aSac.value='';

      if(chkBandas.checked){
        const sumB = sumBandas3From(b1A,b1H,b1L,b2A,b2H,b2L,b3A,b3H,b3L);
        total+=sumB; lines.push(`Bandas: ${fmt1(sumB)} m¬≥`);
      }
      if(chkResane.checked){
        const A=parseDec(sA.value), H=parseDec(sH.value);
        if(isFinite(A)&&isFinite(H)){
          const part=calcResane(A,H); total+=part;
          lines.push(`Resanes: ${fmt1(part)} m¬≥`);
        }
      }
      qOutH2.textContent=`TOTAL: ${fmt1(total)} m¬≥`;
      qMode.textContent=lines.join('\n');
    }

    function onCheckChangeCalculo(){
      togglePane(chkAvance,paneAvance);
      togglePane(chkBandas,paneBandas);
      togglePane(chkResane,paneResane);
      calcTotalCalculo();
    }

    [chkAvance,chkBandas,chkResane].forEach(c=>c.addEventListener('change',onCheckChangeCalculo));
    [aA,aH,aL,aConst,b1A,b1H,b1L,b2A,b2H,b2L,b3A,b3H,b3L,sA,sH].forEach(i=>i.addEventListener('input',calcTotalCalculo));
    document.getElementById('qCalcular').addEventListener('click',calcTotalCalculo);
    document.getElementById('qLimpiar').addEventListener('click',()=>{
      chkAvance.checked=false; chkBandas.checked=false; chkResane.checked=false;
      [aA,aH,aL,b1A,b1H,b1L,b2A,b2H,b2L,b3A,b3H,b3L,sA,sH].forEach(i=>i.value='');
      aConst.value='11.5'; aSac.value='';
      onCheckChangeCalculo();
    });
    onCheckChangeCalculo();

    // ================= REGISTROS =================
    const regFecha=document.getElementById('regFecha');
    const regGuardia=document.getElementById('regGuardia');
    const regLabor=document.getElementById('regLabor');
    const regNivel=document.getElementById('regNivel');
    const regEjecutor=document.getElementById('regEjecutor');
    regFecha.value = todayStr();

    const rChkAvance=document.getElementById('rChkAvance');
    const rChkBandas=document.getElementById('rChkBandas');
    const rChkResane=document.getElementById('rChkResane');

    const rPaneAvance=document.getElementById('rPaneAvance');
    const rPaneBandas=document.getElementById('rPaneBandas');
    const rPaneResane=document.getElementById('rPaneResane');

    const rAA=document.getElementById('rAA');
    const rAH=document.getElementById('rAH');
    const rAL=document.getElementById('rAL');
    const rAConst=document.getElementById('rAConst');
    const rASac=document.getElementById('rASac');

    const rb1A=document.getElementById('rb1A'), rb1H=document.getElementById('rb1H'), rb1L=document.getElementById('rb1L');
    const rb2A=document.getElementById('rb2A'), rb2H=document.getElementById('rb2H'), rb2L=document.getElementById('rb2L');
    const rb3A=document.getElementById('rb3A'), rb3H=document.getElementById('rb3H'), rb3L=document.getElementById('rb3L');

    const rsA=document.getElementById('rsA');
    const rsH=document.getElementById('rsH');

    const rOutH2=document.querySelector('#rOut h2');
    const rOutDetail=document.getElementById('rOutDetail');

    function calcTotalReg(){
      let total=0, partAv=0, partBa=0, partRe=0;
      const lines=[];
      if(!rChkAvance.checked && !rChkBandas.checked && !rChkResane.checked){
        rOutH2.textContent='‚Äî';
        rOutDetail.textContent='';
        rASac.value='';
        return null;
      }

      const det = { avance:null, bandas:[null,null,null], resanes:null };

      if(rChkAvance.checked){
        const A=parseDec(rAA.value), H=parseDec(rAH.value), L=parseDec(rAL.value), C=parseDec(rAConst.value || '11.5');
        if(isFinite(A)&&isFinite(H)&&isFinite(L)&&isFinite(C)&&C>0){
          const base=calcAvanceBase(A,H,L,C);
          const sac=calcFrente(A,H);
          rASac.value=sac.toFixed(2);
          partAv = base + sac;
          total += partAv;
          lines.push(`Avance + Frente: ${fmt1(partAv)} m¬≥`);
          det.avance = {A,H,L,C,Sac:Number(sac.toFixed(2))};
        } else rASac.value='';
      } else rASac.value='';

      if(rChkBandas.checked){
        partBa = sumBandas3From(rb1A,rb1H,rb1L,rb2A,rb2H,rb2L,rb3A,rb3H,rb3L);
        total += partBa;
        lines.push(`Bandas: ${fmt1(partBa)} m¬≥`);
      }

      if(rChkResane.checked){
        const A=parseDec(rsA.value), H=parseDec(rsH.value);
        if(isFinite(A)&&isFinite(H)){
          partRe = calcResane(A,H);
          total += partRe;
          lines.push(`Resanes: ${fmt1(partRe)} m¬≥`);
          det.resanes = {A,H};
        }
      }

      rOutH2.textContent = `TOTAL: ${fmt1(total)} m¬≥`;
      rOutDetail.textContent = lines.join('\n');

      const currentId = (window.__editingId) ? window.__editingId : makeId();

      return {
        id: currentId,
        fecha: regFecha.value || todayStr(),
        guardia: regGuardia.value || '',
        labor: (regLabor.value || '').trim(),
        nivel: (regNivel.value || '').trim(),
        ejecutor: regEjecutor.value || '',
        m3_total: Number(fmt1(total)),
        m3_avance: Number(fmt1(partAv)),
        m3_bandas: Number(fmt1(partBa)),
        m3_resanes: Number(fmt1(partRe)),
        checks: { avance:rChkAvance.checked, bandas:rChkBandas.checked, resanes:rChkResane.checked },
        detalles: det
      };
    }

    function onCheckChangeReg(){
      togglePane(rChkAvance,rPaneAvance);
      togglePane(rChkBandas,rPaneBandas);
      togglePane(rChkResane,rPaneResane);
      calcTotalReg();
    }

    [rChkAvance,rChkBandas,rChkResane].forEach(c=>c.addEventListener('change',onCheckChangeReg));
    [
      rAA,rAH,rAL,rAConst,rb1A,rb1H,rb1L,rb2A,rb2H,rb2L,rb3A,rb3H,rb3L,rsA,rsH,
      regFecha,regGuardia,regLabor,regNivel,regEjecutor
    ].forEach(i=>{
      i.addEventListener('input', calcTotalReg);
      i.addEventListener('change', calcTotalReg);
    });

    function limpiarFormularioRegistros(){
      window.__editingId = null;
      window.__editingOriginalFecha = null;
      regFecha.value = todayStr();
      regGuardia.value = '';
      regLabor.value = '';
      regNivel.value = '';
      regEjecutor.value = '';
      rChkAvance.checked = false;
      rChkBandas.checked = false;
      rChkResane.checked = false;
      [rAA, rAH, rAL, rb1A, rb1H, rb1L, rb2A, rb2H, rb2L, rb3A, rb3H, rb3L, rsA, rsH].forEach(i => i.value = '');
      rAConst.value = '11.5';
      rASac.value = '';
      onCheckChangeReg();
      rOutH2.textContent = '‚Äî';
      rOutDetail.textContent = '';
    }

    document.getElementById('rLimpiar').addEventListener('click', limpiarFormularioRegistros);

    document.getElementById('rGuardar').addEventListener('click', ()=>{
      const fecha = regFecha.value || todayStr();
      const guardia = regGuardia.value || '';
      const labor = (regLabor.value || '').trim();
      const nivel = (regNivel.value || '').trim();
      const ejecutor = regEjecutor.value || '';

      if(!fecha || !guardia || !labor || !nivel || !ejecutor){
        alert('Completa Fecha, Guardia, Labor, Nivel y Ejecutor.');
        return;
      }

      const obj = calcTotalReg();
      if(!obj || !isFinite(obj.m3_total) || obj.m3_total <= 0){
        alert('Completa el c√°lculo (Avance/Bandas/Resanes) para obtener m¬≥ total > 0.');
        return;
      }

      // BD completa
      const db = getDB();
      upsertById(db, obj);
      setDB(db);

      // BD por d√≠a
      const dayDB = getDayDB();
      if (window.__editingId && window.__editingOriginalFecha && window.__editingOriginalFecha !== obj.fecha){
        const oldArr = dayDB[window.__editingOriginalFecha] ?? [];
        removeById(oldArr, obj.id);
        dayDB[window.__editingOriginalFecha] = oldArr;
      }
      const dayArr = dayDB[obj.fecha] ?? [];
      upsertById(dayArr, obj);
      dayDB[obj.fecha] = dayArr;
      setDayDB(dayDB);

      alert('Guardado ‚úÖ');
    });

    onCheckChangeReg();

    // ================= REPORTE =================
    const repFecha = document.getElementById('repFecha');
    const repDayBody = document.getElementById('repDayBody');
    const repSumTotal = document.getElementById('repSumTotal');
    const repSumAvance = document.getElementById('repSumAvance');
    const repSumBandas = document.getElementById('repSumBandas');
    const repSumResanes= document.getElementById('repSumResanes');

    repFecha.value = todayStr();
    repFecha.addEventListener('change', renderDayReport);

    function renderDayReport(){
      const day = repFecha.value || todayStr();
      const dayDB = getDayDB();
      const arr = dayDB[day] ?? [];

      repDayBody.innerHTML = '';
      let sTotal=0, sAv=0, sBa=0, sRe=0;

      arr.forEach((r)=>{
        sTotal += Number(r.m3_total ?? 0);
        sAv += Number(r.m3_avance ?? 0);
        sBa += Number(r.m3_bandas ?? 0);
        sRe += Number(r.m3_resanes ?? 0);

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.fecha ?? ''}</td>
          <td>${r.guardia ?? ''}</td>
          <td>${(r.labor ?? '')} / ${(r.nivel ?? '')}</td>
          <td>${r.ejecutor ?? ''}</td>
          <td>${fmt1(r.m3_total ?? 0)}</td>
          <td>${fmt1(r.m3_avance ?? 0)}</td>
          <td>${fmt1(r.m3_bandas ?? 0)}</td>
          <td>${fmt1(r.m3_resanes ?? 0)}</td>
          <td class="no-print">
            <button class="btn ghost tiny" type="button"
              data-act="del-repday" data-id="${r.id}" data-fecha="${r.fecha}">
              Eliminar
            </button>
          </td>
        `;
        repDayBody.appendChild(tr);
      });

      repSumTotal.textContent = arr.length ? fmt1(sTotal) : '‚Äî';
      repSumAvance.textContent = arr.length ? fmt1(sAv) : '‚Äî';
      repSumBandas.textContent = arr.length ? fmt1(sBa) : '‚Äî';
      repSumResanes.textContent= arr.length ? fmt1(sRe) : '‚Äî';
    }

    repDayBody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button[data-act="del-repday"]');
      if(!btn) return;
      const id = btn.dataset.id;
      const fecha = btn.dataset.fecha;
      if(confirm('¬øEliminar este registro? Esta acci√≥n no se puede deshacer.')){
        deleteRecordEverywhere(id, fecha);
      }
    });

    // ================= HISTORIAL BD =================
    const histBody = document.querySelector('#tblHist tbody');

    function renderHistDB(){
      const regs = getDB();
      histBody.innerHTML = '';

      regs.forEach((r,i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.fecha ?? ''}</td>
          <td>${r.guardia ?? ''}</td>
          <td>${r.labor ?? ''}</td>
          <td>${r.nivel ?? ''}</td>
          <td>${r.ejecutor ?? ''}</td>
          <td>${(r.m3_total!=null)?fmt1(r.m3_total):''}</td>
          <td>${(r.m3_avance!=null)?fmt1(r.m3_avance):''}</td>
          <td>${(r.m3_bandas!=null)?fmt1(r.m3_bandas):''}</td>
          <td>${(r.m3_resanes!=null)?fmt1(r.m3_resanes):''}</td>
          <td class="no-print">
            <button class="btn ghost tiny" type="button" data-act="edit" data-i="${i}">Editar</button>
            <button class="btn ghost tiny" type="button" data-act="del"  data-i="${i}">Eliminar</button>
          </td>
        `;
        histBody.appendChild(tr);
      });

      histBody.querySelectorAll('button').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const i = Number(btn.dataset.i);
          const act = btn.dataset.act;
          const regs = getDB();
          const r = regs[i];
          if(!r) return;

          if(act === 'del'){
            if(!confirm('¬øEliminar este registro del historial?')) return;
            regs.splice(i,1);
            setDB(regs);

            const dayDB = getDayDB();
            const dayArr = dayDB[r.fecha] ?? [];
            removeById(dayArr, r.id);
            dayDB[r.fecha] = dayArr;
            setDayDB(dayDB);

            renderHistDB();
            renderDayReport();
            return;
          }

          if(act === 'edit'){
            window.__editingId = r.id;
            window.__editingOriginalFecha = r.fecha;

            regFecha.value = r.fecha ?? todayStr();
            regGuardia.value = r.guardia ?? '';
            regLabor.value = r.labor ?? '';
            regNivel.value = r.nivel ?? '';
            regEjecutor.value = r.ejecutor ?? '';

            rChkAvance.checked = !!r.checks?.avance;
            rChkBandas.checked = !!r.checks?.bandas;
            rChkResane.checked = !!r.checks?.resanes;

            const det = r.detalles ?? {};
            if(det.avance){
              rAA.value = det.avance.A ?? '';
              rAH.value = det.avance.H ?? '';
              rAL.value = det.avance.L ?? '';
              rAConst.value = det.avance.C ?? '11.5';
              rASac.value = (det.avance.Sac!=null) ? Number(det.avance.Sac).toFixed(2) : '';
            } else {
              rAA.value=''; rAH.value=''; rAL.value=''; rAConst.value='11.5'; rASac.value='';
            }

            onCheckChangeReg();
            switchTab('tab-registros', document.getElementById('btn-registros'));
          }
        });
      });
    }

    // Export CSV BD completa
    function toCSV(regs){
      const headers=['N','id','Fecha','Guardia','Labor','Nivel','Ejecutor','m3_total','m3_avance','m3_bandas','m3_resanes'];
      const esc=(v)=>{ const s=(v==null)?'':String(v); return '"' + s.replace(/"/g,'""') + '"'; };
      const lines=[headers.join(',')];
      regs.forEach((r,i)=>{
        lines.push([
          i+1, r.id, r.fecha, r.guardia, r.labor, r.nivel, r.ejecutor,
          r.m3_total, r.m3_avance, r.m3_bandas, r.m3_resanes
        ].map(esc).join(','));
      });
      return lines.join('\r\n');
    }

    document.getElementById('tblExportCSV').addEventListener('click', ()=>{
      const regs=getDB();
      if(!regs.length){ alert('No hay registros en la BD para exportar.'); return; }
      const csv=toCSV(regs);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`shotcrete-BD-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('tblRefrescar').addEventListener('click', ()=>{
      renderHistDB();
      renderDayReport();
    });

    document.getElementById('tblBorrarTodo').addEventListener('click', ()=>{
      if(confirm('¬øBorrar TODO el historial y reportes por d√≠a?')){
        localStorage.removeItem(LS_DB);
        localStorage.removeItem(LS_DAY);
        renderHistDB();
        renderDayReport();
      }
    });

    // ================= Gr√°fico + PDF (igual que antes) =================
    function aggregateByLabor(dayRecords){
      const map = new Map();
      for(const r of dayRecords){
        const lab = ((r.labor ?? 'Sin labor').trim() || 'Sin labor');
        const val = Number(r.m3_total ?? 0);
        map.set(lab, (map.get(lab) ?? 0) + val);
      }
      return [...map.entries()].sort((a,b)=>b[1]-a[1]);
    }

    function drawBarChartToCanvas(data, fecha){
      const canvas = document.createElement('canvas');
      const width = 900, height = 420;
      canvas.width = width; canvas.height = height;

      const ctx = canvas.getContext('2d');
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,width,height);

      const padL = 90, padR = 30, padT = 50, padB = 90;
      const chartW = width - padL - padR;
      const chartH = height - padT - padB;

      ctx.fillStyle = '#111';
      ctx.font = 'bold 22px Arial';
      ctx.fillText('Lanzado por Labor (m¬≥_total)', padL, 28);
      ctx.font = '14px Arial';
      ctx.fillStyle = '#444';
      ctx.fillText(`Fecha: ${fecha}`, padL, 48);

      if(!data.length){
        ctx.font = '16px Arial';
        ctx.fillStyle = '#111';
        ctx.fillText('Sin registros para esta fecha.', padL, padT + 30);
        return canvas;
      }

      const maxVal = Math.max(...data.map(d=>d[1]), 1);
      const n = data.length;
      const gap = Math.max(10, Math.floor(chartW * 0.02));
      const barW = Math.max(18, Math.floor((chartW - gap*(n-1)) / n));

      ctx.strokeStyle = '#333';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT + chartH);
      ctx.lineTo(padL + chartW, padT + chartH);
      ctx.stroke();

      ctx.font = '12px Arial';
      ctx.fillStyle = '#444';
      ctx.strokeStyle = '#e5e7eb';
      ctx.lineWidth = 1;
      const ticks = 5;
      for(let t=0; t<=ticks; t++){
        const y = padT + chartH - (chartH * t / ticks);
        const v = (maxVal * t / ticks);
        ctx.beginPath();
        ctx.moveTo(padL, y);
        ctx.lineTo(padL + chartW, y);
        ctx.stroke();
        ctx.fillText(v.toFixed(1), 20, y + 4);
      }

      for(let i=0;i<n;i++){
        const [lab, val] = data[i];
        const h = (val / maxVal) * chartH;
        const x = padL + i*(barW + gap);
        const y = padT + chartH - h;

        ctx.fillStyle = '#ff6a00';
        ctx.fillRect(x, y, barW, h);

        ctx.fillStyle = '#111';
        ctx.font = 'bold 12px Arial';
        ctx.fillText(val.toFixed(1), x, y - 6);

        const label = lab.length > 14 ? lab.slice(0,13)+'‚Ä¶' : lab;
        ctx.save();
        ctx.translate(x + barW/2, padT + chartH + 22);
        ctx.rotate(-Math.PI/6);
        ctx.font = '12px Arial';
        ctx.fillStyle = '#111';
        ctx.textAlign = 'center';
        ctx.fillText(label, 0, 0);
        ctx.restore();
      }
      return canvas;
    }

    document.getElementById('repPrint').addEventListener('click', ()=>{
      const day = repFecha.value || todayStr();
      const dayDB = getDayDB();
      const records = dayDB[day] ?? [];

      let sTotal=0, sAv=0, sBa=0, sRe=0;
      records.forEach(r=>{
        sTotal += Number(r.m3_total ?? 0);
        sAv += Number(r.m3_avance ?? 0);
        sBa += Number(r.m3_bandas ?? 0);
        sRe += Number(r.m3_resanes ?? 0);
      });

      document.getElementById('printMeta').textContent =
        `Fecha: ${day}\nGenerado: ${new Date().toLocaleString()}`;

      document.getElementById('printSums').innerHTML =
        `<b>Œ£ m¬≥_total:</b> ${fmt1(sTotal)} 
         <b>Œ£ Avance:</b> ${fmt1(sAv)} 
         <b>Œ£ Bandas:</b> ${fmt1(sBa)} 
         <b>Œ£ Resanes:</b> ${fmt1(sRe)}`;

      const agg = aggregateByLabor(records);
      const canvas = drawBarChartToCanvas(agg, day);
      const chartWrap = document.getElementById('printChartWrap');
      chartWrap.innerHTML = '';
      chartWrap.appendChild(canvas);

      const rowsHtml = records.map(r => `
        <tr>
          <td>${r.fecha ?? ''}</td>
          <td>${r.guardia ?? ''}</td>
          <td>${(r.labor ?? '')} / ${(r.nivel ?? '')}</td>
          <td>${r.ejecutor ?? ''}</td>
          <td>${fmt1(r.m3_total ?? 0)}</td>
          <td>${fmt1(r.m3_avance ?? 0)}</td>
          <td>${fmt1(r.m3_bandas ?? 0)}</td>
          <td>${fmt1(r.m3_resanes ?? 0)}</td>
        </tr>
      `).join('');

      document.getElementById('printTableWrap').innerHTML = `
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>Guardia</th><th>Labor / Nivel</th><th>Ejecutor</th>
              <th>m¬≥ Total</th><th>Avance</th><th>Bandas</th><th>Resanes</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
          <tfoot>
            <tr>
              <th colspan="4">TOTAL D√çA</th>
              <th>${fmt1(sTotal)}</th>
              <th>${fmt1(sAv)}</th>
              <th>${fmt1(sBa)}</th>
              <th>${fmt1(sRe)}</th>
            </tr>
          </tfoot>
        </table>
      `;

      window.print();
    });

    // Inicial
    renderDayReport();
    renderHistDB();

    // --- Service Worker ---
    (function(){
      if('serviceWorker' in navigator){
        const swUrl='/shotcrete-calc/sw.js';
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register(swUrl, { scope: '/shotcrete-calc/' }).catch(()=>{});
        });
      }
    })();

    // --- Loader control ---
    (function(){
      const loader = document.getElementById('appLoader');
      if(!loader) return;
      const safetyHide = setTimeout(hideLoader, 6000);
      window.addEventListener('load', hideLoader);
      function hideLoader(){
        clearTimeout(safetyHide);
        loader.classList.add('hidden');
        setTimeout(()=>{ loader.style.display='none'; }, 400);
      }
    })();
  </script>
</body>
</html>
