<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Inspección de lanzado de Shotcrete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA (ajustado al sub-path del repo en GitHub Pages) -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json">
  <!-- Si ya tienes icono, descomenta la línea siguiente -->
  <!-- <link rel="apple-touch-icon" href="/shotcrete-calc/icon-192.png"> -->
  <meta name="theme-color" content="#0a84ff">

  <!-- Estilos: tema claro/oscuro con alto contraste + UI compacta -->
  <style>
    :root {
      /* Paleta (modo claro) */
      --bg: #ffffff;
      --text: #0f0f10;
      --muted: #5c6170;
      --primary: #0a2cff;
      --primary-2: #4f7cff;
      --accent: #0a84ff;
      --panel: #f8f9fb;
      --border: #e2e6ef;
      --table-head-bg: #eef2ff;
      --table-row-hover: #f7f9ff;

      --font-size: 15px;          /* tamaño general reducido */
      --font-size-small: 13px;    /* tablas y notas */
      --radius: 8px;
    }

    [data-theme="dark"] {
      --bg: #0f1320;
      --text: #f2f4fb;
      --muted: #c0c6d8;
      --primary: #8ab4ff;
      --primary-2: #517abf;
      --accent: #8ab4ff;
      --panel: #1a2035;
      --border: #2a3353;
      --table-head-bg: #202a47;
      --table-row-hover: #1d2540;
    }
    [data-theme="light"] { /* usa valores de :root */ }

    @media (prefers-color-scheme: dark) {
      :root:not([data-theme]) {
        --bg: #0f1320;
        --text: #f2f4fb;
        --muted: #c0c6d8;
        --primary: #8ab4ff;
        --primary-2: #517abf;
        --accent: #8ab4ff;
        --panel: #1a2035;
        --border: #2a3353;
        --table-head-bg: #202a47;
        --table-row-hover: #1d2540;
      }
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-size: var(--font-size);
    }
    .container { margin: 16px; max-width: 980px; }

    /* Encabezado */
    .brand-header {
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
      color: #fff;
      padding: 16px;
      border-bottom: 3px solid var(--accent);
      text-align: center;
    }
    .brand-title { margin: 0; font-size: 1.4rem; font-weight: 800; }
    .brand-sub   { margin: 4px 0 0 0; font-size: 0.85rem; opacity: 0.9; font-style: italic; }

    /* Selector de tema en header */
    .theme-row {
      display: flex; justify-content: center; gap: 8px; margin-top: 8px;
      font-size: var(--font-size-small);
      align-items: center;
    }
    .theme-row label { font-weight: 600; color: #fff; }
    .theme-row select {
      background: #ffffff; color: #0f0f10; border: 1px solid var(--border);
      border-radius: 6px; padding: 4px 6px;
    }
    [data-theme="dark"] .theme-row select,
    :root:not([data-theme]) @media (prefers-color-scheme: dark) .theme-row select {
      background: #12172b; color: #e8eaf1; border-color: #2a3353;
    }

    /* Tabs */
    .tabs { margin-top: 12px; border-bottom: 1px solid var(--border); display: flex; gap: 8px; flex-wrap: wrap; }
    .tab-btn {
      appearance: none; border: 1px solid var(--border); background: var(--table-head-bg);
      color: var(--primary); padding: 6px 10px; border-radius: var(--radius) var(--radius) 0 0;
      cursor: pointer; font-weight: 600; font-size: 14px;
    }
    .tab-btn[aria-selected="true"] { background: var(--primary); color: #fff; border-color: var(--primary); }
    .tab-content { display: none; padding-top: 12px; }
    .tab-content.active { display: block; }

    /* Formulario */
    label { display: block; margin-top: 10px; font-weight: 600; font-size: 14px; color: var(--text); }
    input, select, textarea {
      width: 100%; padding: 8px; font-size: 14px;
      border: 1px solid var(--border); border-radius: 6px;
      background: #fff; color: #000; /* legible en claro */
    }
    /* legible en oscuro */
    [data-theme="dark"] input, [data-theme="dark"] select, [data-theme="dark"] textarea,
    :root:not([data-theme]) @media (prefers-color-scheme: dark) input,
    :root:not([data-theme]) @media (prefers-color-scheme: dark) select,
    :root:not([data-theme]) @media (prefers-color-scheme: dark) textarea {
      background: #12172b; color: #e8eaf1; border-color: #2a3353;
    }
    textarea { min-height: 60px; resize: vertical; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 560px) { .row2, .row3 { grid-template-columns: 1fr; } }

    .actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button {
      padding: 10px; font-size: 14px;
      background: var(--accent); color: #fff; border: 0; border-radius: 6px; cursor: pointer;
    }
    button.secondary { background: var(--table-head-bg); color: var(--primary); border: 1px solid var(--border); }
    .btn-danger { background: #ff5a5f; }

    .panel {
      margin-top: 14px; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--panel);
    }
    .result-title { font-size: 0.85rem; color: var(--muted); }
    .result-value { font-size: 1.4rem; font-weight: 700; margin: 6px 0; color: var(--accent); }
    .summary { color: var(--text); font-size: 0.85rem; white-space: pre-line; }
    .error { color: #ff6b6b; font-size: 0.85rem; margin-top: 8px; }

    /* Tabla */
    .table-wrap { margin-top: 8px; border: 1px solid var(--border); border-radius: 6px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: var(--font-size-small); background: var(--bg); color: var(--text); }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    th { background: var(--table-head-bg); color: var(--primary); position: sticky; top: 0; }
    tr:hover { background: var(--table-row-hover); }
    .no-data { padding: 12px; color: var(--muted); }

    .footer { margin: 20px 16px; color: var(--muted); font-size: 0.8rem; text-align: center; }
  </style>
</head>
<body>
  <!-- Encabezado -->
  <header class="brand-header">
    <h1 class="brand-title">Inspección de lanzado de Shotcrete</h1>
    <p class="brand-sub">Área de Control de Calidad</p>

    <!-- Selector de tema -->
    <div class="theme-row" aria-label="Selector de tema">
      <label for="tema">Tema:</label>
      <select id="tema">
        <option value="auto">Auto (según sistema)</option>
        <option value="light">Claro</option>
        <option value="dark">Oscuro</option>
      </select>
    </div>
  </header>

  <main class="container">
    <!-- Tabs (ahora con 3 pestañas; la primera es “Cálculo rápido”) -->
    <div class="tabs" role="tablist" aria-label="Navegación de pestañas">
      <button id="tab-rapido-btn"   class="tab-btn" role="tab" aria-controls="tab-rapido"   aria-selected="true">Cálculo rápido</button>
      <button id="tab-ingreso-btn"  class="tab-btn" role="tab" aria-controls="tab-ingreso"  aria-selected="false">Ingreso / Calcular</button>
      <button id="tab-registros-btn" class="tab-btn" role="tab" aria-controls="tab-registros" aria-selected="false">Registros</button>
    </div>

    <!-- Tab 1: Cálculo rápido (solo A, H, L y Frente) -->
    <section id="tab-rapido" class="tab-content active" role="tabpanel" aria-labelledby="tab-rapido-btn">
      <p class="desc" style="color:var(--muted); font-size:var(--font-size-small); margin:0 0 6px;">
        Ingrese A, H, L y el Frente de sacrificio. Se usa factor fijo <strong>11.5</strong>. Total = m³ base + frente.
      </p>

      <div class="row3">
        <div>
          <label>Ancho (A) [m]
            <input id="r-ancho" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
        <div>
          <label>Altura (H) [m]
            <input id="r-altura" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
        <div>
          <label>Largo (L) [m]
            <input id="r-largo" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
      </div>

      <label>Frente de sacrificio (m³)
        <input id="r-frente" type="number" step="0.001" value="0" placeholder="0.000" />
      </label>

      <!-- Botones -->
      <div class="actions">
        <button id="r-btn-calcular">Calcular m³</button>
        <button class="secondary" id="r-btn-limpiar">Limpiar</button>
      </div>

      <!-- Mensajes -->
      <div id="r-msg" class="error" role="alert" aria-live="polite"></div>

      <!-- Panel resultado rápido -->
      <div class="panel" id="r-panel" style="display:none;">
        <div class="result-title">Resultado</div>
        <div class="result-value" id="r-valor">0.000 m³</div>
        <div class="summary" id="r-resumen">—</div>
      </div>
    </section>

    <!-- Tab 2: Ingreso / Calcular (formulario completo) -->
    <section id="tab-ingreso" class="tab-content" role="tabpanel" aria-labelledby="tab-ingreso-btn">
      <!-- Orden: Fecha primero -->
      <label>Fecha
        <input id="fecha" type="date" />
      </label>

      <div class="row2">
        <div>
          <label>Labor
            <input id="labor" placeholder="Nombre de la labor" />
          </label>
        </div>
        <div>
          <label>Nivel (Nv.)
            <input id="nivel" placeholder="Nivel" />
          </label>
        </div>
      </div>

      <!-- Dimensiones -->
      <div class="row3">
        <div>
          <label>Ancho (A) [m]
            <input id="ancho" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
        <div>
          <label>Largo (L) [m]
            <input id="largo" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
        <div>
          <label>Altura (H) [m]
            <input id="altura" type="number" step="0.01" placeholder="0.00" />
          </label>
        </div>
      </div>

      <label>Factor (por defecto 11.5)
        <input id="factor" type="number" step="0.01" value="11.5" />
      </label>

      <!-- Frente de sacrificio (se suma al final) -->
      <label>Frente de sacrificio (m³)
        <input id="frente" type="number" step="0.001" value="0" placeholder="0.000" />
      </label>

      <!-- Guardia y USO -->
      <div class="row2">
        <div>
          <label>Guardia
            <input id="guardia" placeholder="Ej.: A / B / C / Día / Noche" />
          </label>
        </div>
        <div>
          <label>USO
            <select id="uso">
              <option value="REP">REP</option>
              <option value="REO">REO</option>
              <option value="REH">REH</option>
              <option value="OPE">OPE</option>
            </select>
          </label>
        </div>
      </div>

      <label>Observaciones
        <textarea id="observaciones" placeholder="Notas u observaciones"></textarea>
      </label>

      <!-- Botones -->
      <div class="actions">
        <button id="btn-calcular">Calcular m³</button>
        <button class="secondary" id="btn-guardar">Guardar registro</button>
        <button class="secondary" id="btn-limpiar">Limpiar</button>
      </div>

      <div id="msg" class="error" role="alert" aria-live="polite"></div>

      <!-- Panel resultado -->
      <div class="panel" id="panel-resultado" style="display:none;">
        <div class="result-title">Resultado</div>
        <div class="result-value" id="valor-m3">0.000 m³</div>
        <div class="summary" id="resumen">—</div>
      </div>
    </section>

    <!-- Tab 3: Registros -->
    <section id="tab-registros" class="tab-content" role="tabpanel" aria-labelledby="tab-registros-btn">
      <div class="actions" style="justify-content:flex-end;">
        <button class="secondary" id="btn-csv">Exportar CSV</button>
        <button class="btn-danger" id="btn-borrar-todo" title="Borrar todos los registros">Borrar todo</button>
      </div>
      <div class="table-wrap">
        <table aria-label="Registros guardados">
          <thead>
            <tr>
              <th>Fecha</th><th>Labor</th><th>Nivel</th><th>Guardia</th><th>USO</th>
              <th>A</th><th>L</th><th>H</th><th>Factor</th><th>m³ base</th><th>Frente</th><th>m³ total</th><th>Obs.</th><th>Acción</th>
            </tr>
          </thead>
          <tbody id="tbody-registros">
            <tr class="no-data"><td colspan="14">Sin registros guardados</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <div class="footer">
      Fórmula base: <code>m³ = ((((H × 2) + A) × 0.9) × L) / factor</code> — Total: <code>m³ base + frente</code><br>
      © <span id="year"></span> — By Cesar Laura
    </div>
  </main>

  <!-- Registro del Service Worker con scope del repo -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/shotcrete-calc/sw.js', { scope: '/shotcrete-calc/' })
          .catch(console.error);
      });
    }
  </script>

  <!-- Lógica: tema, tabs, cálculo rápido, cálculo completo, guardado, borrado, tabla y CSV -->
  <script>
    /* ====== Tema (Auto / Claro / Oscuro) ====== */
    (function initTheme(){
      const saved = localStorage.getItem('sc_tema'); // 'auto' | 'light' | 'dark'
      if (saved && saved !== 'auto') {
        document.documentElement.setAttribute('data-theme', saved);
      } else {
        document.documentElement.removeAttribute('data-theme');
      }
      const sel = document.getElementById('tema');
      if (sel) sel.value = saved || 'auto';
    })();
    document.getElementById('tema').addEventListener('change', (e) => {
      const val = e.target.value;
      localStorage.setItem('sc_tema', val);
      if (val === 'auto') {
        document.documentElement.removeAttribute('data-theme');
      } else {
        document.documentElement.setAttribute('data-theme', val);
      }
    });

    /* ====== Estado & elementos ====== */
    const STORAGE_FORM = 'sc_form';
    const STORAGE_REGS = 'sc_registros';
    const STORAGE_TAB  = 'sc_tab_activa';
    const FACTOR_DEF   = 11.5; // factor fijo para Cálculo rápido

    const els = {
      // Rápido
      rA: document.getElementById('r-ancho'),
      rH: document.getElementById('r-altura'),
      rL: document.getElementById('r-largo'),
      rFrente: document.getElementById('r-frente'),
      rMsg: document.getElementById('r-msg'),
      rPanel: document.getElementById('r-panel'),
      rValor: document.getElementById('r-valor'),
      rResumen: document.getElementById('r-resumen'),
      rBtnCalc: document.getElementById('r-btn-calcular'),
      rBtnLimpiar: document.getElementById('r-btn-limpiar'),

      // Completo
      fecha: document.getElementById('fecha'),
      labor: document.getElementById('labor'),
      nivel: document.getElementById('nivel'),
      ancho: document.getElementById('ancho'),
      largo: document.getElementById('largo'),
      altura: document.getElementById('altura'),
      factor: document.getElementById('factor'),
      frente: document.getElementById('frente'),
      guardia: document.getElementById('guardia'),
      uso: document.getElementById('uso'),
      observaciones: document.getElementById('observaciones'),
      msg: document.getElementById('msg'),
      panel: document.getElementById('panel-resultado'),
      valor: document.getElementById('valor-m3'),
      resumen: document.getElementById('resumen'),
      btnCalcular: document.getElementById('btn-calcular'),
      btnGuardar: document.getElementById('btn-guardar'),
      btnLimpiar: document.getElementById('btn-limpiar'),

      // Tabs
      tabRapidoBtn: document.getElementById('tab-rapido-btn'),
      tabIngresoBtn: document.getElementById('tab-ingreso-btn'),
      tabRegistrosBtn: document.getElementById('tab-registros-btn'),
      tabRapido: document.getElementById('tab-rapido'),
      tabIngreso: document.getElementById('tab-ingreso'),
      tabRegistros: document.getElementById('tab-registros'),

      // Registros
      tbody: document.getElementById('tbody-registros'),
      btnCSV: document.getElementById('btn-csv'),
      btnBorrarTodo: document.getElementById('btn-borrar-todo')
    };

    let registros = []; // {id, fecha, labor, nivel, guardia, uso, observaciones, A, L, H, factor, frente, m3Base, m3Total}

    /* ====== Tabs ====== */
    function switchTab(name) {
      const rapido  = name === 'rapido';
      const ingreso = name === 'ingreso';
      const registrosTab = name === 'registros';

      els.tabRapido.classList.toggle('active', rapido);
      els.tabIngreso.classList.toggle('active', ingreso);
      els.tabRegistros.classList.toggle('active', registrosTab);

      els.tabRapidoBtn.setAttribute('aria-selected', rapido ? 'true' : 'false');
      els.tabIngresoBtn.setAttribute('aria-selected', ingreso ? 'true' : 'false');
      els.tabRegistrosBtn.setAttribute('aria-selected', registrosTab ? 'true' : 'false');

      localStorage.setItem(STORAGE_TAB, name);
    }
    els.tabRapidoBtn.addEventListener('click', () => switchTab('rapido'));
    els.tabIngresoBtn.addEventListener('click', () => switchTab('ingreso'));
    els.tabRegistrosBtn.addEventListener('click', () => switchTab('registros'));

    /* ====== Carga inicial ====== */
    window.addEventListener('DOMContentLoaded', () => {
      // Restaurar formulario completo
      const last = JSON.parse(localStorage.getItem(STORAGE_FORM) || '{}');
      Object.entries(last).forEach(([k,v]) => { if (els[k] !== undefined) els[k].value = v; });

      // Cargar registros
      registros = JSON.parse(localStorage.getItem(STORAGE_REGS) || '[]');
      ordenarPorFechaDesc();
      renderTabla();

      // Tab previa (por defecto: rápido)
      const t = localStorage.getItem(STORAGE_TAB) || 'rapido';
      switchTab(t);
    });

    // Guardar últimos valores del formulario completo
    ['fecha','labor','nivel','ancho','largo','altura','factor','frente','guardia','uso','observaciones'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', () => {
        const data = {
          fecha: els.fecha.value, labor: els.labor.value, nivel: els.nivel.value,
          ancho: els.ancho.value, largo: els.largo.value, altura: els.altura.value,
          factor: els.factor.value, frente: els.frente.value,
          guardia: els.guardia.value, uso: els.uso.value, observaciones: els.observaciones.value
        };
        localStorage.setItem(STORAGE_FORM, JSON.stringify(data));
      });
    });

    /* ====== Cálculo rápido (factor fijo 11.5) ====== */
    function calcularRapido(){
      els.rMsg.textContent = '';
      const A  = parseFloat(els.rA.value);
      const H  = parseFloat(els.rH.value);
      const L  = parseFloat(els.rL.value);
      const fr = parseFloat(els.rFrente.value || '0');

      if ([A,H,L].some(v => isNaN(v))) {
        els.rPanel.style.display = 'none';
        els.rMsg.textContent = 'Verifica que A, H y L sean números válidos.';
        return;
      }
      if (A < 0 || H < 0 || L <= 0 || (isNaN(fr) || fr < 0)) {
        els.rPanel.style.display = 'none';
        els.rMsg.textContent = 'Valores deben ser positivos; Frente puede ser 0 o mayor.';
        return;
      }

      const m3Base  = ((((H * 2) + A) * 0.9) * L) / FACTOR_DEF;
      const m3Total = m3Base + fr;

      els.rPanel.style.display = 'block';
      els.rValor.textContent = `${m3Total.toFixed(3)} m³`;
      els.rResumen.textContent =
        `m³ base: ${m3Base.toFixed(3)} | Frente: ${fr.toFixed(3)} | Total: ${m3Total.toFixed(3)}\n` +
        `A=${A.toFixed(2)} m, H=${H.toFixed(2)} m, L=${L.toFixed(2)} m • Factor( fijo )=${FACTOR_DEF.toFixed(2)}`;
    }

    function limpiarRapido(){
      ['r-ancho','r-altura','r-largo'].forEach(id => document.getElementById(id).value = '');
      els.rFrente.value = '0';
      els.rMsg.textContent = '';
      els.rPanel.style.display = 'none';
    }

    els.rBtnCalc.addEventListener('click', calcularRapido);
    els.rBtnLimpiar.addEventListener('click', limpiarRapido);

    /* ====== Cálculo completo (incluye frente y factor editable) ====== */
    function calcular(){
      els.msg.textContent = '';
      const labor = els.labor.value.trim();
      const nivel = els.nivel.value.trim();
      const A = parseFloat(els.ancho.value);
      const L = parseFloat(els.largo.value);
      const H = parseFloat(els.altura.value);
      const f = parseFloat(els.factor.value);
      const fr = parseFloat(els.frente.value || '0');

      if ([A,L,H,f].some(v => isNaN(v))) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Verifica que A, L, H y el factor sean números válidos.';
        return;
      }
      if (A < 0 || H < 0 || L <= 0 || f <= 0 || (isNaN(fr) || fr < 0)) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Valores deben ser positivos; frente puede ser 0 o mayor.';
        return;
      }

      const m3Base  = ((((H * 2) + A) * 0.9) * L) / f;
      const m3Total = m3Base + fr;

      els.panel.style.display = 'block';
      els.valor.textContent = `${m3Total.toFixed(3)} m³`;
      const resumenTxt =
        `m³ base: ${m3Base.toFixed(3)} | Frente: ${fr.toFixed(3)} | Total: ${m3Total.toFixed(3)}\n` +
        `Labor: ${labor || '—'} • Nivel: ${nivel || '—'} • A=${A.toFixed(2)} m, L=${L.toFixed(2)} m, H=${H.toFixed(2)} m • Factor=${f.toFixed(2)}`;
      els.resumen.textContent = resumenTxt;

      return { m3Base, m3Total, frente: fr };
    }

    /* ====== Guardar registro ====== */
    function guardarRegistro(){
      els.msg.textContent = '';

      const fecha = els.fecha.value;
      if (!fecha) { els.msg.textContent = 'La fecha es obligatoria.'; return; }

      const calc = calcular();
      if (!calc || typeof calc.m3Base !== 'number') return;

      const reg = {
        id: Date.now(),
        fecha,
        labor: els.labor.value.trim(),
        nivel: els.nivel.value.trim(),
        guardia: els.guardia.value.trim(),
        uso: els.uso.value,
        observaciones: els.observaciones.value.trim(),
        ancho: parseFloat(els.ancho.value),
        largo: parseFloat(els.largo.value),
        altura: parseFloat(els.altura.value),
        factor: parseFloat(els.factor.value),
        frente: parseFloat(calc.frente.toFixed(3)),
        m3Base: parseFloat(calc.m3Base.toFixed(3)),
        m3Total: parseFloat(calc.m3Total.toFixed(3))
      };

      registros.push(reg);
      ordenarPorFechaDesc();
      localStorage.setItem(STORAGE_REGS, JSON.stringify(registros));
      renderTabla();

      els.msg.style.color = '#00c28a';
      els.msg.textContent = 'Registro guardado correctamente.';
      setTimeout(() => { els.msg.style.color = '#ff6b6b'; els.msg.textContent = ''; }, 1200);
      switchTab('registros');
    }

    /* ====== Borrado de registros ====== */
    function borrarRegistro(id){
      registros = registros.filter(r => r.id !== id);
      localStorage.setItem(STORAGE_REGS, JSON.stringify(registros));
      renderTabla();
    }
    els.tbody.addEventListener('click', (e) => {
      const btn = e.target.closest('.btn-del');
      if (!btn) return;
      const id = Number(btn.dataset.id);
      if (!id) return;
      if (confirm('¿Eliminar este registro?')) borrarRegistro(id);
    });
    els.btnBorrarTodo.addEventListener('click', () => {
      if (!registros.length) return;
      if (confirm('¿Eliminar TODOS los registros? Esta acción no se puede deshacer.')) {
        registros = [];
        localStorage.setItem(STORAGE_REGS, JSON.stringify(registros));
        renderTabla();
      }
    });

    /* ====== Tabla ====== */
    function ordenarPorFechaDesc(){ registros.sort((a,b) => new Date(b.fecha) - new Date(a.fecha)); }
    function formatearFecha(yyyy_mm_dd){ const [y,m,d] = yyyy_mm_dd.split('-'); return `${d}/${m}/${y}`; }
    function num(n, dec=2){ return typeof n === 'number' && isFinite(n) ? n.toFixed(dec) : '—'; }
    function esc(s){ return (s || '—').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

    function renderTabla(){
      const tbody = els.tbody;
      tbody.innerHTML = '';
      if (!registros.length) {
        const tr = document.createElement('tr');
        tr.className = 'no-data';
        const td = document.createElement('td');
        td.colSpan = 14;
        td.textContent = 'Sin registros guardados';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }
      registros.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatearFecha(r.fecha)}</td>
          <td>${esc(r.labor)}</td>
          <td>${esc(r.nivel)}</td>
          <td>${esc(r.guardia)}</td>
          <td>${esc(r.uso)}</td>
          <td>${num(r.ancho)}</td>
          <td>${num(r.largo)}</td>
          <td>${num(r.altura)}</td>
          <td>${num(r.factor)}</td>
          <td>${num(r.m3Base, 3)}</td>
          <td>${num(r.frente, 3)}</td>
          <td>${num(r.m3Total, 3)}</td>
          <td>${esc(r.observaciones)}</td>
          <td><button class="btn-danger btn-del" data-id="${r.id}" title="Eliminar">Eliminar</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    /* ====== CSV ====== */
    function exportarCSV(){
      const hdr = ['Fecha','Labor','Nivel','Guardia','USO','A(m)','L(m)','H(m)','Factor','m3_base','Frente','m3_total','Observaciones'];
      const filas = registros.map(r => [
        r.fecha, r.labor, r.nivel, r.guardia, r.uso,
        (isFinite(r.ancho)?r.ancho:''), (isFinite(r.largo)?r.largo:''), (isFinite(r.altura)?r.altura:''),
        (isFinite(r.factor)?r.factor:''), (isFinite(r.m3Base)?r.m3Base:''), (isFinite(r.frente)?r.frente:''), (isFinite(r.m3Total)?r.m3Total:''), r.observaciones
      ]);
      let csv = hdr.join(',') + '\n' + filas
        .map(f => f.map(x => typeof x === 'string' && x.includes(',') ? `"${x.replace(/"/g,'""')}"` : x).join(','))
        .join('\n') + '\n';
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      const fecha = new Date().toISOString().slice(0,10);
      a.download = `inspeccion_shotcrete_${fecha}.csv`;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(url); document.body.removeChild(a); }, 500);
    }

    /* ====== Eventos ====== */
    els.btnCalcular.addEventListener('click', calcular);
    els.btnGuardar.addEventListener('click', guardarRegistro);
    els.btnCSV.addEventListener('click', exportarCSV);
    els.btnLimpiar.addEventListener('click', () => {
      ['fecha','labor','nivel','ancho','largo','altura','factor','frente','guardia','uso','observaciones']
        .forEach(id => { if (id==='uso') els[id].value='REP'; else els[id].value = ''; });
      els.factor.value = '11.5';
      els.frente.value = '0';
      els.panel.style.display = 'none';
      els.msg.textContent = '';
      localStorage.removeItem(STORAGE_FORM);
      switchTab('ingreso');
    });
  </script>
</body>
</html>
