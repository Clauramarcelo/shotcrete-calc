
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Shotcrete Calc</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA (ajustadas al sub-path de GitHub Pages) -->
  /shotcrete-calc/manifest.json
  /shotcrete-calc/icon-192.png
  <meta name="theme-color" content="#0a84ff">

  <!-- Estilos -->
  <style>
    :root { color-scheme: light dark; }
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 16px; max-width: 980px;
    }
    h1 { font-size: 1.6rem; margin-bottom: 6px; }
    p.desc { color: #666; margin-top: 0; }

    /* --- Tabs --- */
    .tabs {
      margin-top: 12px;
      border-bottom: 1px solid #e3e3e3;
      display: flex; gap: 8px; flex-wrap: wrap;
    }
    .tab-btn {
      appearance: none; border: 1px solid #cfd7ff; background: #eef2ff;
      color: #0a2cff; padding: 8px 12px; border-radius: 8px 8px 0 0;
      cursor: pointer; font-weight: 600;
    }
    .tab-btn[aria-selected="true"] {
      background: #0a2cff; color: white; border-color: #0a2cff;
    }
    .tab-content { display: none; padding-top: 12px; }
    .tab-content.active { display: block; }

    /* --- Formulario y layout --- */
    label { display: block; margin-top: 12px; font-weight: 600; }
    input, select, textarea {
      width: 100%; padding: 10px; font-size: 1rem;
      border: 1px solid #ccc; border-radius: 8px;
    }
    textarea { min-height: 72px; resize: vertical; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
    @media (max-width: 560px) {
      .row2, .row3 { grid-template-columns: 1fr; }
    }

    .actions { display: flex; gap: 12px; margin-top: 16px; flex-wrap: wrap; }
    button {
      padding: 12px; font-size: 1rem;
      background: #0a84ff; color: white; border: 0; border-radius: 8px;
      cursor: pointer;
    }
    button.secondary { background: #eef2ff; color: #0a2cff; }

    .panel {
      margin-top: 16px; padding: 14px; border: 1px solid #e3e3e3; border-radius: 10px;
      background: #f8f9fb;
    }
    .result-title { font-size: 0.95rem; color: #666; }
    .result-value { font-size: 1.8rem; font-weight: 800; margin: 6px 0; color: #0a2cff; }
    @media (min-width: 480px) { .result-value { font-size: 2rem; } }
    .summary { color: #444; font-size: 0.95rem; }
    .error { color: #b00020; font-size: 0.95rem; margin-top: 10px; }
    .footer { margin-top: 24px; color: #666; font-size: 0.9rem; }

    /* --- Tabla de registros --- */
    .table-wrap { margin-top: 8px; border: 1px solid #e3e3e3; border-radius: 8px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
    th, td { padding: 10px; border-bottom: 1px solid #ececec; text-align: left; }
    th { background: #f1f5ff; color: #0a2cff; position: sticky; top: 0; }
    tr:hover { background: #fafafa; }
    .no-data { padding: 16px; color: #666; }
  </style>
</head>
<body>
  <h1>Shotcrete Calc</h1>
  <p class="desc">Pestañas: <strong>Ingreso / Calcular</strong> y <strong>Registros</strong>. Guarda y visualiza tu control ordenado por fecha.</p>

  <!-- Tabs header -->
  <div class="tabs" role="tablist" aria-label="Navegación de pestañas">
    <button id="tab-ingreso-btn" class="tab-btn" role="tab" aria-controls="tab-ingreso" aria-selected="true">Ingreso / Calcular</button>
    <button id="tab-registros-btn" class="tab-btn" role="tab" aria-controls="tab-registros" aria-selected="false">Registros</button>
  </div>

  <!-- Tab 1: Ingreso / Calcular -->
  <section id="tab-ingreso" class="tab-content active" role="tabpanel" aria-labelledby="tab-ingreso-btn">
    <!-- Datos descriptivos de labor -->
    <div class="row2">
      <div>
        <label>Labor
          <input id="labor" placeholder="Nombre de la labor" />
        </label>
      </div>
      <div>
        <label>Nivel (Nv.)
          <input id="nivel" placeholder="Nivel" />
        </label>
      </div>
    </div>

    <!-- Dimensiones -->
    <div class="row3">
      <div>
        <label>Ancho (A) [m]
          <input id="ancho" type="number" step="0.01" placeholder="0.00" />
        </label>
      </div>
      <div>
        <label>Largo (L) [m]
          <input id="largo" type="number" step="0.01" placeholder="0.00" />
        </label>
      </div>
      <div>
        <label>Altura (H) [m]
          <input id="altura" type="number" step="0.01" placeholder="0.00" />
        </label>
      </div>
    </div>

    <!-- Factor -->
    <label>Factor (por defecto 11.5)
      <input id="factor" type="number" step="0.01" value="11.5" />
    </label>

    <!-- Nuevos datos de entrada -->
    <div class="row3">
      <div>
        <label>Fecha
          <input id="fecha" type="date" />
        </label>
      </div>
      <div>
        <label>Guardia
          <input id="guardia" placeholder="Ej.: A / B / C / Día / Noche" />
        </label>
      </div>
      <div>
        <label>USO
          <select id="uso">
            <option value="REP">REP</option>
            <option value="REO">REO</option>
            <option value="REH">REH</option>
            <option value="OPE">OPE</option>
          </select>
        </label>
      </div>
    </div>

    <label>Observaciones
      <textarea id="observaciones" placeholder="Notas u observaciones"></textarea>
    </label>

    <!-- Acciones -->
    <div class="actions">
      <button id="btn-calcular">Calcular m³</button>
      <button class="secondary" id="btn-guardar">Guardar registro</button>
      <button class="secondary" id="btn-limpiar">Limpiar</button>
      <label style="display:flex; align-items:center; gap:8px; font-weight:400;">
        <input type="checkbox" id="autoCalc" />
        Calcular automáticamente al escribir
      </label>
    </div>

    <!-- Mensajes -->
    <div id="msg" class="error"></div>

    <!-- Panel de resultados -->
    <div class="panel" id="panel-resultado" style="display:none;">
      <div class="result-title">Resultado</div>
      <div class="result-value" id="valor-m3">0.000 m³</div>
      <div class="summary" id="resumen">—</div>
    </div>
  </section>

  <!-- Tab 2: Registros -->
  <section id="tab-registros" class="tab-content" role="tabpanel" aria-labelledby="tab-registros-btn">
    <div class="table-wrap" id="lista-wrap">
      <table id="tabla-registros">
        <thead>
          <tr>
            <th>Fecha</th>
            <th>Guardia</th>
            <th>USO</th>
            <th>Labor</th>
            <th>Nivel</th>
            <th>A (m)</th>
            <th>L (m)</th>
            <th>H (m)</th>
            <th>Factor</th>
            <th>m³</th>
            <th>Observaciones</th>
          </tr>
        </thead>
        <tbody id="tbody-registros">
          <tr class="no-data"><td colspan="11">Sin registros guardados</td></tr>
        </tbody>
      </table>
    </div>
  </section>

  <div class="footer">
    Fórmula: <code>m³ = ((((H × 2) + A) × 0.9) × L) / factor</code>
  </div>

  <!-- Registro del Service Worker con scope del repo -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('/shotcrete-calc/sw.js', { scope: '/shotcrete-calc/' })
          .catch(console.error);
      });
    }
  </script>

  <!-- Lógica: tabs, calculadora y registros -->
  <script>
    const STORAGE_FORM = 'sc_form';
    const STORAGE_REGS = 'sc_registros';
    const STORAGE_TAB = 'sc_tab_activa';

    // Elementos
    const els = {
      labor: document.getElementById('labor'),
      nivel: document.getElementById('nivel'),
      ancho: document.getElementById('ancho'),
      largo: document.getElementById('largo'),
      altura: document.getElementById('altura'),
      factor: document.getElementById('factor'),
      fecha: document.getElementById('fecha'),
      guardia: document.getElementById('guardia'),
      uso: document.getElementById('uso'),
      observaciones: document.getElementById('observaciones'),

      msg: document.getElementById('msg'),
      panel: document.getElementById('panel-resultado'),
      valor: document.getElementById('valor-m3'),
      resumen: document.getElementById('resumen'),

      btnCalcular: document.getElementById('btn-calcular'),
      btnGuardar: document.getElementById('btn-guardar'),
      btnLimpiar: document.getElementById('btn-limpiar'),
      autoCalc: document.getElementById('autoCalc'),

      tabIngresoBtn: document.getElementById('tab-ingreso-btn'),
      tabRegistrosBtn: document.getElementById('tab-registros-btn'),
      tabIngreso: document.getElementById('tab-ingreso'),
      tabRegistros: document.getElementById('tab-registros'),

      tbody: document.getElementById('tbody-registros')
    };

    let registros = [];

    // --- Tabs ---
    function switchTab(name) {
      const ingreso = name === 'ingreso';
      els.tabIngreso.classList.toggle('active', ingreso);
      els.tabRegistros.classList.toggle('active', !ingreso);

      els.tabIngresoBtn.setAttribute('aria-selected', ingreso ? 'true' : 'false');
      els.tabRegistrosBtn.setAttribute('aria-selected', ingreso ? 'false' : 'true');

      localStorage.setItem(STORAGE_TAB, name);
    }

    els.tabIngresoBtn.addEventListener('click', () => switchTab('ingreso'));
    els.tabRegistrosBtn.addEventListener('click', () => switchTab('registros'));

    // Cargar estado inicial
    window.addEventListener('DOMContentLoaded', () => {
      // Últimos valores del formulario
      const last = JSON.parse(localStorage.getItem(STORAGE_FORM) || '{}');
      Object.entries(last).forEach(([k,v]) => { if (els[k]) els[k].value = v; });

      // Registros previos
      registros = JSON.parse(localStorage.getItem(STORAGE_REGS) || '[]');
      ordenarPorFechaDesc();
      renderTabla();

      // Tab activa previa
      const t = localStorage.getItem(STORAGE_TAB) || 'ingreso';
      switchTab(t);
    });

    // Guardar últimos valores al escribir + autocalcular
    ['labor','nivel','ancho','largo','altura','factor','fecha','guardia','uso','observaciones'].forEach(id => {
      document.getElementById(id).addEventListener('input', () => {
        const data = {
          labor: els.labor.value, nivel: els.nivel.value,
          ancho: els.ancho.value, largo: els.largo.value, altura: els.altura.value,
          factor: els.factor.value, fecha: els.fecha.value, guardia: els.guardia.value,
          uso: els.uso.value, observaciones: els.observaciones.value
        };
        localStorage.setItem(STORAGE_FORM, JSON.stringify(data));
        if (els.autoCalc.checked) calcular();
      });
    });

    // --- Cálculo ---
    function calcular(){
      els.msg.textContent = '';
      const labor = els.labor.value.trim();
      const nivel = els.nivel.value.trim();
      const A = parseFloat(els.ancho.value);
      const L = parseFloat(els.largo.value);
      const H = parseFloat(els.altura.value);
      const f = parseFloat(els.factor.value);

      if ([A,L,H,f].some(v => isNaN(v))) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Verifica que A, L, H y el factor sean números válidos.';
        return;
      }
      if (A < 0 || H < 0 || L <= 0 || f <= 0) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Los valores deben ser positivos y L/factor mayores a 0.';
        return;
      }

      const m3 = ((((H * 2) + A) * 0.9) * L) / f;

      els.panel.style.display = 'block';
      els.valor.textContent = `${m3.toFixed(3)} m³`;
      const resumenTxt = `Labor: ${labor || '—'} • Nivel: ${nivel || '—'} • A=${A.toFixed(2)} m, L=${L.toFixed(2)} m, H=${H.toFixed(2)} m • Factor=${f.toFixed(2)}`;
      els.resumen.textContent = resumenTxt;

      return m3;
    }

    // --- Guardar registro y pasar a pestaña Registros ---
    function guardarRegistro(){
      els.msg.textContent = '';

      const fecha = els.fecha.value; // yyyy-mm-dd
      if (!fecha) { els.msg.textContent = 'La fecha es obligatoria.'; return; }

      let m3 = calcular();
      if (typeof m3 !== 'number') {
        const A = parseFloat(els.ancho.value);
        const L = parseFloat(els.largo.value);
        const H = parseFloat(els.altura.value);
        const f = parseFloat(els.factor.value);
        if ([A,L,H,f].some(v => isNaN(v)) || A < 0 || H < 0 || L <= 0 || f <= 0) return;
        m3 = ((((H * 2) + A) * 0.9) * L) / f;
      }

      const reg = {
        fecha,
        guardia: els.guardia.value.trim(),
        uso: els.uso.value,
        observaciones: els.observaciones.value.trim(),
        labor: els.labor.value.trim(),
        nivel: els.nivel.value.trim(),
        ancho: parseFloat(els.ancho.value),
        largo: parseFloat(els.largo.value),
        altura: parseFloat(els.altura.value),
        factor: parseFloat(els.factor.value),
        m3: parseFloat(m3.toFixed(3))
      };

      registros.push(reg);
      ordenarPorFechaDesc();
      localStorage.setItem(STORAGE_REGS, JSON.stringify(registros));
      renderTabla();

      // feedback y cambio de pestaña
      els.msg.style.color = '#0a7'; // verde
      els.msg.textContent = 'Registro guardado correctamente.';
      setTimeout(() => { els.msg.style.color = '#b00020'; els.msg.textContent = ''; }, 1200);

      switchTab('registros');
    }

    // Ordenar por fecha descendente
    function ordenarPorFechaDesc(){
      registros.sort((a,b) => new Date(b.fecha) - new Date(a.fecha));
    }

    // Renderizar tabla
    function renderTabla(){
      const tbody = els.tbody;
      tbody.innerHTML = '';
      if (!registros.length) {
        const tr = document.createElement('tr');
        tr.className = 'no-data';
        const td = document.createElement('td');
        td.colSpan = 11;
        td.textContent = 'Sin registros guardados';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      registros.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${formatearFecha(r.fecha)}</td>
          <td>${esc(r.guardia)}</td>
          <td>${esc(r.uso)}</td>
          <td>${esc(r.labor)}</td>
          <td>${esc(r.nivel)}</td>
          <td>${num(r.ancho)}</td>
          <td>${num(r.largo)}</td>
          <td>${num(r.altura)}</td>
          <td>${num(r.factor)}</td>
          <td>${num(r.m3, 3)}</td>
          <td>${esc(r.observaciones)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function formatearFecha(yyyy_mm_dd){
      const [y,m,d] = yyyy_mm_dd.split('-');
      return `${d}/${m}/${y}`;
    }
    function num(n, dec=2){
      return typeof n === 'number' && isFinite(n) ? n.toFixed(dec) : '—';
    }
    function esc(s){ return (s || '—').replace(/[<>&]/g, c => ({'<':'&lt;','>':'&gt;','&':'&amp;'}[c])); }

    // Eventos
    els.btnCalcular.addEventListener('click', calcular);
    els.btnGuardar.addEventListener('click', guardarRegistro);
    els.btnLimpiar.addEventListener('click', () => {
      ['labor','nivel','ancho','largo','altura','factor','fecha','guardia','uso','observaciones']
        .forEach(id => { if (id==='uso') els[id].value='REP'; else els[id].value = ''; });
      els.factor.value = '11.5';
      els.panel.style.display = 'none';
      els.msg.textContent = '';
      localStorage.removeItem(STORAGE_FORM);
      switchTab('ingreso');
    });
  </script>
</body>
</html>
