
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shotcrete Calc</title>

  <!-- Manifest e ícono (si lo tienes) -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json">
  <link rel="icon" href="/shotcrete-calc/icon-192.png" sizes="192x192">
  <meta name="theme-color" content="#0a84ff">

  <style>
    :root{
      --brand:#0a84ff; --brand-2:#166ef2;
      --bg:#ffffff; --fg:#0b0b0b; --muted:#667085; --card:#f6f8fa; --border:#d0d5dd;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0b0b; --fg:#eee; --muted:#98a2b3; --card:#14171a; --border:#2a2e33; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.35; padding-bottom:env(safe-area-inset-bottom)
    }
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg,var(--brand),var(--brand-2)); color:#fff;
      padding:calc(.6rem + env(safe-area-inset-top)) 1rem .6rem 1rem;
      display:flex; align-items:center; gap:.75rem; box-shadow:0 2px 12px rgba(0,0,0,.12);
    }
    header .logo{ width:28px; height:28px; border-radius:6px; background:#fff2; display:inline-block }
    header h1{ margin:0; font-size:1.1rem }

    main{ max-width:960px; margin:0 auto; padding:1rem; padding-bottom:4.5rem }

    fieldset{ border:1px solid var(--border); border-radius:.8rem; background:var(--card); padding:1rem; margin:0 0 1rem }
    legend{ font-weight:700; padding:0 .5rem }
    label{ display:block; margin:.55rem 0 .25rem }

    input,select{
      width:100%; padding:.65rem .75rem; font-size:1rem;
      border:1px solid var(--border); border-radius:.6rem; background:#fff; outline:none;
    }
    @media (prefers-color-scheme: dark){ input,select{ background:#0e0e10; color:var(--fg) } }

    .row2{ display:grid; grid-template-columns:1fr 1fr; gap:1rem }
    .row3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:1rem }
    @media (max-width:820px){ .row3{ grid-template-columns:1fr 1fr } }
    @media (max-width:560px){ .row3{ grid-template-columns:1fr } .row2{ grid-template-columns:1fr } }

    .actions{ display:flex; flex-wrap:wrap; gap:.6rem; margin-top:.8rem }
    .btn{ border:none; border-radius:.6rem; padding:.7rem 1rem; font-size:1rem; display:inline-flex; align-items:center; gap:.5rem; cursor:pointer }
    .btn.primary{ background:var(--brand); color:#fff }
    .btn.secondary{ background:#2f3b48; color:#fff }
    .btn.ghost{ background:transparent; color:var(--brand); border:1px solid var(--brand) }

    .result{ margin-top:.9rem; padding:1rem; border-radius:.8rem; background:#fff; border:1px dashed var(--border); display:flex; align-items:center; justify-content:center; text-align:center }
    @media (prefers-color-scheme: dark){ .result{ background:#0e0e10 } }
    .result h2{ margin:0; font-size:clamp(1.6rem,4vw,2.2rem); font-weight:800; color:#0a84ff }
    .result small{ display:block; color:var(--muted); margin-top:.25rem }

    table{ width:100%; border-collapse:collapse; }
    th, td{ border:1px solid var(--border); padding:.55rem; text-align:left; }
    thead th{ background:#eef3ff; }
    @media (prefers-color-scheme: dark){
      thead th{ background:#0f203a; color:#cfe0ff; }
    }

    .tabbar{
      position:fixed; left:0; right:0; bottom:0; z-index:60; background:var(--bg); border-top:1px solid var(--border);
      padding:.35rem calc(.6rem + env(safe-area-inset-bottom)) .35rem .6rem; display:grid; grid-template-columns:repeat(5,1fr); gap:.25rem;
    }
    .tabbar button{
      appearance:none; border:none; background:transparent; color:#667085;
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:.25rem;
      padding:.5rem 0; border-radius:.5rem; cursor:pointer; font-size:.9rem;
    }
    .tabbar button.active{ color:#0a84ff; font-weight:700; background:var(--card) }
    section.tab{ display:none }
    section.tab.active{ display:block }

    .mode{ display:flex; gap:.5rem; align-items:center; margin:.2rem 0 .4rem }
    .mode label{ display:flex; align-items:center; gap:.4rem; margin:0 }
  </style>
</head>
<body>
  <header>
    <span class="logo" aria-hidden="true"></span>
    <h1>Shotcrete Calc</h1>
  </header>

  <main>
    <!-- ====== 1) CALCULO m3 (rápido) ====== -->
    <section id="tab-calculo" class="tab active" aria-labelledby="btn-calculo">
      <fieldset>
        <legend>Calculo m3</legend>

        <div class="mode" role="group" aria-label="Modo de cálculo">
          <label><input type="radio" name="modoQuick" value="tunnel" checked> Avance (túnel)</label>
          <label><input type="radio" name="modoQuick" value="wall"> Resane (hastial)</label>
        </div>

        <div class="row3">
          <div>
            <label for="qA">Ancho (A) — m</label>
            <input id="qA" type="text" inputmode="decimal" placeholder="Ej. 4.0">
          </div>
          <div>
            <label for="qH">Altura (H) — m</label>
            <input id="qH" type="text" inputmode="decimal" placeholder="Ej. 3.5">
          </div>
          <div>
            <label for="qL">Largo (L) — m</label>
            <input id="qL" type="text" inputmode="decimal" placeholder="Ej. 20.0">
          </div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="qSac">Frente de sacrificio — m³</label>
            <input id="qSac" type="text" inputmode="decimal" placeholder="Ej. 0.5">
          </div>
          <div>
            <label for="qConst">Constante (m²/m³)</label>
            <input id="qConst" type="text" inputmode="decimal" value="11.5" placeholder="Ej. 11.5">
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="qCalcular">Calcular</button>
          <button class="btn ghost" id="qLimpiar">Limpiar</button>
        </div>

        <div id="qOut" class="result" aria-live="polite">
          <h2>—</h2>
          <small id="qMode">Selecciona modo y completa los datos.</small>
        </div>
      </fieldset>
    </section>

    <!-- ====== 2) REGISTROS (con su propia calculadora) ====== -->
    <section id="tab-registros" class="tab" aria-labelledby="btn-registros">
      <fieldset>
        <legend>Calculadora de Registros</legend>

        <div class="mode" role="group" aria-label="Modo de cálculo">
          <label><input type="radio" name="modoRegCalc" value="tunnel" checked> Avance (túnel)</label>
          <label><input type="radio" name="modoRegCalc" value="wall"> Resane (hastial)</label>
        </div>

        <div class="row3">
          <div>
            <label for="rA">Ancho (A) — m</label>
            <input id="rA" type="text" inputmode="decimal" placeholder="Ej. 4.0">
          </div>
          <div>
            <label for="rH">Altura (H) — m</label>
            <input id="rH" type="text" inputmode="decimal" placeholder="Ej. 3.5">
          </div>
          <div>
            <label for="rL">Largo (L) — m</label>
            <input id="rL" type="text" inputmode="decimal" placeholder="Ej. 20.0">
          </div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="rSac">Frente de sacrificio — m³</label>
            <input id="rSac" type="text" inputmode="decimal" placeholder="Ej. 0.5">
          </div>
          <div>
            <label for="rConst">Constante (m²/m³)</label>
            <input id="rConst" type="text" inputmode="decimal" value="11.5" placeholder="Ej. 11.5">
          </div>
        </div>

        <div id="rOut" class="result" aria-live="polite">
          <h2>—</h2>
          <small id="rMode">Selecciona modo y completa los datos.</small>
        </div>
      </fieldset>

      <fieldset>
        <legend>Registro de actividad</legend>

        <div class="row3">
          <div>
            <label for="regFecha">Fecha</label>
            <input id="regFecha" type="date" />
          </div>
          <div>
            <label for="regNivel">Nivel</label>
            <input id="regNivel" type="text" placeholder="Ej. 350 NE" />
          </div>
          <div>
            <label for="regLabor">Labor</label>
            <input id="regLabor" type="text" placeholder="Ej. Carguío 1201" />
          </div>
        </div>

        <div class="row3" style="margin-top:.6rem">
          <div>
            <label for="regRobot">N° Robot</label>
            <input id="regRobot" type="text" placeholder="Ej. Alpha 20-03" />
          </div>
          <div>
            <label for="regPresion">Presión de aire (bar)</label>
            <input id="regPresion" type="number" step="0.1" min="0" placeholder="Ej. 4.5" />
          </div>
          <div>
            <label for="regUso">USO</label>
            <select id="regUso">
              <option value="" selected disabled>Selecciona…</option>
              <option value="NIC">NIC</option>
              <option value="REH">REH</option>
              <option value="REP">REP</option>
              <option value="OPE">OPE</option>
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="regObs">Observaciones</label>
            <input id="regObs" type="text" placeholder="Notas de operación..." />
          </div>
          <div class="actions" style="align-items:end; justify-content:flex-end;">
            <button class="btn primary" id="regCalcularGuardar">Calcular y guardar</button>
            <button class="btn ghost" id="regLimpiar">Limpiar</button>
          </div>
        </div>

        <div class="actions" style="margin-top:.6rem">
          <button class="btn ghost" id="regExport">Exportar JSON</button>
          <button class="btn ghost" id="regImportBtn">Importar JSON</button>
          <input id="regImportFile" type="file" accept="application/json" style="display:none">
          <button class="btn ghost" id="regBorrarTodo">Borrar todo</button>
        </div>
      </fieldset>

      <fieldset>
        <legend>Registros guardados (offline)</legend>
        <table id="tblRegistros">
          <thead>
            <tr>
              <th>Fecha</th>
              <th>Nivel</th>
              <th>Labor</th>
              <th>N° Robot</th>
              <th>Presión (bar)</th>
              <th>USO</th>
              <th>Obs.</th>
              <th>Modo</th>
              <th>m³</th>
              <th>Const.</th>
              <th>Sac.</th>
              <th>A/H/L</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </section>

    <!-- ====== 3) TABLAS (gestión de registros + CSV) ====== -->
    <section id="tab-tablas" class="tab" aria-labelledby="btn-tablas">
      <fieldset>
        <legend>Tabla de registros (CSV)</legend>
        <div class="actions">
          <button class="btn primary" id="tbl3ExportCSV">Exportar a CSV</button>
          <button class="btn ghost"   id="tbl3Refrescar">Refrescar</button>
          <button class="btn secondary" id="tbl3BorrarTodo">Borrar todo</button>
        </div>
        <table id="tbl3">
          <thead>
            <tr>
              <th>#</th>
              <th>Fecha</th>
              <th>Nivel</th>
              <th>Labor</th>
              <th>N° Robot</th>
              <th>Presión (bar)</th>
              <th>USO</th>
              <th>Obs.</th>
              <th>Modo</th>
              <th>m³</th>
              <th>Const.</th>
              <th>Sac.</th>
              <th>A/H/L</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </section>

    <!-- ====== 4) DASHBOARD ====== -->
    <section id="tab-dashboard" class="tab" aria-labelledby="btn-dashboard">
      <fieldset><legend>Dashboard</legend><p class="muted">Próximo: KPIs y gráficas.</p></fieldset>
    </section>

    <!-- ====== 5) ENSAYOS ====== -->
    <section id="tab-ensayos" class="tab" aria-labelledby="btn-ensayos">
      <fieldset><legend>Ensayos de Resistencias</legend><p class="muted">Próximo: cálculo y registro de f’c.</p></fieldset>
    </section>
  </main>

  <nav class="tabbar" role="tablist" aria-label="Navegación">
    <button id="btn-calculo"  class="active" role="tab" aria-controls="tab-calculo"  aria-selected="true">Calculo m3</button>
    <button id="btn-registros" role="tab" aria-controls="tab-registros" aria-selected="false">Registros</button>
    <button id="btn-tablas"   role="tab" aria-controls="tab-tablas"   aria-selected="false">Tablas</button>
    <button id="btn-dashboard"role="tab" aria-controls="tab-dashboard"aria-selected="false">Dashboard</button>
    <button id="btn-ensayos"  role="tab" aria-controls="tab-ensayos"  aria-selected="false">Ensayos</button>
  </nav>

  <script>
    /* =================== Tabs =================== */
    const tabsMap = [
      {btn:'btn-calculo',   tab:'tab-calculo'},
      {btn:'btn-registros', tab:'tab-registros'},
      {btn:'btn-tablas',    tab:'tab-tablas'},
      {btn:'btn-dashboard', tab:'tab-dashboard'},
      {btn:'btn-ensayos',   tab:'tab-ensayos'}
    ];
    tabsMap.forEach(({btn, tab})=>{
      const b = document.getElementById(btn);
      b?.addEventListener('click', ()=>{
        document.querySelectorAll('.tabbar button').forEach(el=>{
          el.classList.toggle('active', el.id === btn);
          el.setAttribute('aria-selected', el.id === btn ? 'true' : 'false');
        });
        document.querySelectorAll('section.tab').forEach(el=>{
          el.classList.toggle('active', el.id === tab);
        });
        if (tab === 'tab-calculo'){ document.getElementById('qA')?.focus({preventScroll:true}); }
        if (tab === 'tab-registros'){ document.getElementById('rA')?.focus({preventScroll:true}); }
        if (tab === 'tab-tablas'){ renderTbl3(); }
      });
    });

    /* =================== Utilidades =================== */
    function parseDec(txt){
      if (typeof txt !== 'string') return NaN;
      const s = txt.trim().replace(',', '.');
      if (s === '') return NaN;
      return Number(s);
    }
    const fmt1 = (n) => Number(n).toFixed(1);
    const todayStr = () => new Date().toISOString().slice(0,10); // YYYY-MM-DD

    /* =================== CALCULO m3 (rápido) =================== */
    const qA = document.getElementById('qA');
    const qH = document.getElementById('qH');
    const qL = document.getElementById('qL');
    const qSac = document.getElementById('qSac');
    const qConst = document.getElementById('qConst');
    const qOutH2 = document.querySelector('#qOut h2');
    const qOutMode = document.getElementById('qMode');
    const qRadios = document.querySelectorAll('input[name="modoQuick"]');

    function nombreModoQuick(){
      const m = [...qRadios].find(r => r.checked)?.value || 'tunnel';
      return m === 'tunnel' ? 'Avance' : 'Resane';
    }
    function calcularQuick(){
      const A   = parseDec(qA?.value ?? '');
      const H   = parseDec(qH?.value ?? '');
      const L   = parseDec(qL?.value ?? '');
      const Sac = parseDec(qSac?.value ?? '0');
      const C   = parseDec(qConst?.value ?? '11.5');
      const m   = [...qRadios].find(r => r.checked)?.value || 'tunnel';

      if (!isFinite(L) || !isFinite(H) || !isFinite(C) || C<=0){
        qOutH2.textContent = '—'; qOutMode.textContent = 'Completa los datos.'; return;
      }
      if (m === 'tunnel' && !isFinite(A)){
        qOutH2.textContent = '—'; qOutMode.textContent = 'Completa A, H y L.'; return;
      }

      let m3_base = 0;
      if (m === 'tunnel'){
        const perimetroParcial  = (H * 2) + A;
        const perimetroAjustado = perimetroParcial * 0.9;
        const areaLineal        = perimetroAjustado * L;
        m3_base = areaLineal / C;
      } else {
        m3_base = (L * H) / C;
      }
      const m3_total = m3_base + (isFinite(Sac) ? Sac : 0);
      qOutH2.textContent = `${nombreModoQuick()}: ${fmt1(m3_total)} m³`;
      qOutMode.textContent = '';
    }
    document.getElementById('qCalcular')?.addEventListener('click', calcularQuick);
    document.getElementById('qLimpiar')?.addEventListener('click', ()=>{
      [qA, qH, qL, qSac].forEach(i=>{ if (i) i.value=''; });
      qConst.value = '11.5';
      document.querySelector('input[name="modoQuick"][value="tunnel"]').checked = true;
      qOutH2.textContent = '—'; qOutMode.textContent = 'Selecciona modo y completa los datos.'; qA?.focus();
    });
    [qA, qH, qL, qSac, qConst, ...qRadios].forEach(el=>{
      el?.addEventListener('input', ()=>{
        const m = [...qRadios].find(r => r.checked)?.value || 'tunnel';
        const wallReady   = (qH?.value.trim() && qL?.value.trim());
        const tunnelReady = (qA?.value.trim() && wallReady);
        const ready = (m === 'wall') ? wallReady : tunnelReady;
        if (ready) calcularQuick(); else { qOutH2.textContent = '—'; qOutMode.textContent = 'Selecciona modo y completa los datos.'; }
      });
      el?.addEventListener('keydown', (ev)=>{ if (ev.key === 'Enter') calcularQuick(); });
    });

    /* =================== REGISTROS (calculadora + formulario) =================== */
    const rA = document.getElementById('rA');
    const rH = document.getElementById('rH');
    const rL = document.getElementById('rL');
    const rSac = document.getElementById('rSac');
    const rConst = document.getElementById('rConst');
    const rOutH2 = document.querySelector('#rOut h2');
    const rOutMode = document.getElementById('rMode');
    const rRadios = document.querySelectorAll('input[name="modoRegCalc"]');

    function nombreModoReg(){
      const m = [...rRadios].find(r => r.checked)?.value || 'tunnel';
      return m === 'tunnel' ? 'Avance' : 'Resane';
    }
    function calcularReg(){
      const A   = parseDec(rA?.value ?? '');
      const H   = parseDec(rH?.value ?? '');
      const L   = parseDec(rL?.value ?? '');
      const Sac = parseDec(rSac?.value ?? '0');
      const C   = parseDec(rConst?.value ?? '11.5');
      const m   = [...rRadios].find(r => r.checked)?.value || 'tunnel';

      if (!isFinite(L) || !isFinite(H) || !isFinite(C) || C<=0){
        rOutH2.textContent = '—'; rOutMode.textContent = 'Completa los datos.'; return {ok:false};
      }
      if (m === 'tunnel' && !isFinite(A)){
        rOutH2.textContent = '—'; rOutMode.textContent = 'Completa A, H y L.'; return {ok:false};
      }

      let m3_base = 0;
      if (m === 'tunnel'){
        const perimetroParcial  = (H * 2) + A;
        const perimetroAjustado = perimetroParcial * 0.9;
        const areaLineal        = perimetroAjustado * L;
        m3_base = areaLineal / C;
      } else {
        m3_base = (L * H) / C;
      }
      const m3_total = m3_base + (isFinite(Sac) ? Sac : 0);
      rOutH2.textContent = `${nombreModoReg()}: ${fmt1(m3_total)} m³`;
      rOutMode.textContent = '';
      return {ok:true, modo:nombreModoReg(), m3:Number(fmt1(m3_total)), A:isFinite(A)?A:null, H, L, C, Sac:isFinite(Sac)?Sac:0 };
    }

    const LS_REGS   = 'sc_registros';
    const regFecha  = document.getElementById('regFecha');
    const regNivel  = document.getElementById('regNivel');
    const regLabor  = document.getElementById('regLabor');
    const regRobot  = document.getElementById('regRobot');
    const regPresion= document.getElementById('regPresion');
    const regUso    = document.getElementById('regUso');
    const regObs    = document.getElementById('regObs');
    const tblRegBody= document.querySelector('#tblRegistros tbody');

    function getRegs(){ try { return JSON.parse(localStorage.getItem(LS_REGS)) ?? []; } catch { return []; } }
    function setRegs(arr){ localStorage.setItem(LS_REGS, JSON.stringify(arr)); }

    function limpiarRegistro(){
      regFecha.value = todayStr();
      regNivel.value = '';
      regLabor.value = '';
      regRobot.value = '';
      regPresion.value = '';
      regUso.value = '';
      regObs.value = '';
    }
    limpiarRegistro();

    document.getElementById('regCalcularGuardar')?.addEventListener('click', ()=>{
      const calc = calcularReg();
      if (!calc.ok){ alert('Completa la calculadora de registros.'); return; }

      const fecha   = regFecha.value || todayStr();
      const nivel   = regNivel.value.trim();
      const labor   = regLabor.value.trim();
      const robot   = regRobot.value.trim();
      const presion = parseDec(regPresion.value || '');
      const uso     = regUso.value;
      const obs     = regObs.value.trim();

      if (!fecha || !nivel || !labor || !robot || !isFinite(presion) || !uso){
        alert('Completa Fecha, Nivel, Labor, N° Robot, Presión (bar) y USO.');
        return;
      }

      const regs = getRegs();
      regs.push({
        fecha, nivel, labor, robot,
        presion: Number(presion.toFixed(2)), uso, obs,
        modo: calc.modo, m3: calc.m3, C: calc.C, Sac: calc.Sac,
        A: calc.A, H: calc.H, L: calc.L
      });
      setRegs(regs);
      renderRegs();
      alert('Registro guardado.');
    });

    document.getElementById('regLimpiar')?.addEventListener('click', limpiarRegistro);

    document.getElementById('regExport')?.addEventListener('click', ()=>{
      const regs = getRegs();
      const blob = new Blob([JSON.stringify({registros: regs}, null, 2)], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `shotcrete-registros-${Date.now()}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    document.getElementById('regImportBtn')?.addEventListener('click', ()=> document.getElementById('regImportFile').click());
    document.getElementById('regImportFile')?.addEventListener('change', async (ev)=>{
      const file = ev.target.files[0];
      if (!file) return;
      try {
        const txt = await file.text();
        const obj = JSON.parse(txt);
        if (Array.isArray(obj)) setRegs(obj);
        else if (Array.isArray(obj.registros)) setRegs(obj.registros);
        else { alert('Formato JSON inválido.'); ev.target.value = ''; return; }
        renderRegs(); renderTbl3();
        alert('Registros importados.');
      } catch { alert('No se pudo leer el archivo.'); }
      ev.target.value = '';
    });
    document.getElementById('regBorrarTodo')?.addEventListener('click', ()=>{
      if (confirm('¿Borrar TODOS los registros?')) {
        localStorage.removeItem(LS_REGS);
        renderRegs(); renderTbl3();
      }
    });

    function renderRegs(){
      const regs = getRegs();
      tblRegBody.innerHTML = '';
      regs.forEach((r, i) => {
        const tr = document.createElement('tr');
        const m3txt  = (r.m3 == null) ? '—' : fmt1(r.m3);
        const constxt= (r.C ?? '—');
        const sactxt = (r.Sac ?? '—');
        const ahltxt = (r.A ?? '—') + '/' + (r.H ?? '—') + '/' + (r.L ?? '—');

        tr.innerHTML = `
          <td>${r.fecha}</td>
          <td>${r.nivel}</td>
          <td>${r.labor}</td>
          <td>${r.robot}</td>
          <td>${r.presion}</td>
          <td>${r.uso ?? '—'}</td>
          <td>${r.obs || ''}</td>
          <td>${r.modo ?? '—'}</td>
          <td>${m3txt}</td>
          <td>${constxt}</td>
          <td>${sactxt}</td>
          <td>${ahltxt}</td>
          <td><button class="btn ghost" data-i="${i}">Eliminar</button></td>
        `;
        tblRegBody.appendChild(tr);
        tr.querySelector('button')?.addEventListener('click', ()=>{
          const arr = getRegs(); arr.splice(i,1); setRegs(arr); renderRegs(); renderTbl3();
        });
      });
    }
    renderRegs();

    /* =================== TABLAS (Pestaña 3) =================== */
    const tbl3Body = document.querySelector('#tbl3 tbody');
    function renderTbl3(){
      const regs = getRegs();
      tbl3Body.innerHTML = '';
      regs.forEach((r, i) => {
        const tr = document.createElement('tr');
        const m3txt  = (r.m3 == null) ? '—' : fmt1(r.m3);
        const constxt= (r.C ?? '—');
        const sactxt = (r.Sac ?? '—');
        const ahltxt = (r.A ?? '—') + '/' + (r.H ?? '—') + '/' + (r.L ?? '—');

        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${r.fecha}</td>
          <td>${r.nivel}</td>
          <td>${r.labor}</td>
          <td>${r.robot}</td>
          <td>${r.presion}</td>
          <td>${r.uso ?? '—'}</td>
          <td>${r.obs || ''}</td>
          <td>${r.modo ?? '—'}</td>
          <td>${m3txt}</td>
          <td>${constxt}</td>
          <td>${sactxt}</td>
          <td>${ahltxt}</td>
          <td><button class="btn ghost" data-i="${i}">Eliminar</button></td>
        `;
        tbl3Body.appendChild(tr);
        tr.querySelector('button')?.addEventListener('click', ()=>{
          const arr = getRegs(); arr.splice(i,1); setRegs(arr); renderTbl3(); renderRegs();
        });
      });
    }

    function toCSV(regs){
      const headers = [
        'N','Fecha','Nivel','Labor','Nro Robot','Presion (bar)','USO',
        'Observaciones','Modo','m3','Constante','Sacrificio','A','H','L'
      ];
      const esc = (v) => {
        const s = (v==null) ? '' : String(v);
        return '"' + s.replace(/"/g,'""') + '"';
      };
      const lines = [headers.join(',')];
      regs.forEach((r,i)=>{
        lines.push([
          i+1, r.fecha, r.nivel, r.labor, r.robot, r.presion, r.uso,
          r.obs||'', r.modo, (r.m3==null? '' : fmt1(r.m3)), r.C, r.Sac, r.A, r.H, r.L
        ].map(esc).join(','));
      });
      return lines.join('\r\n');
    }

    document.getElementById('tbl3ExportCSV')?.addEventListener('click', ()=>{
      const regs = getRegs();
      if (!regs.length){ alert('No hay registros para exportar.'); return; }
      const csv = toCSV(regs);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `shotcrete-registros-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('tbl3Refrescar')?.addEventListener('click', renderTbl3);

    document.getElementById('tbl3BorrarTodo')?.addEventListener('click', ()=>{
      if (confirm('¿Borrar TODOS los registros?')) {
        localStorage.removeItem(LS_REGS);
        renderTbl3(); renderRegs();
      }
    });

    /* =================== Service Worker =================== */
    (function(){
      if ('serviceWorker' in navigator){
        const swUrl = '/shotcrete-calc/sw.js';
        window.addEventListener('load', ()=>{
          navigator.serviceWorker.register(swUrl).catch(()=>{});
        });
      }
    })();
  </script>
</body>
</html>
