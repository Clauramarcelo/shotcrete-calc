<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shotcrete Calc</title>

  <!-- Manifest PWA -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json" />
  <meta name="theme-color" content="#ff6a00" />

  <!-- Apple PWA (opcional) -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <link rel="apple-touch-icon" href="/shotcrete-calc/icon-192.png" />

  <style>
    :root{
      --brand:#ff6a00;
      --brand-2:#ff821a;

      --bg:#ffffff; --fg:#0b0b0b; --muted:#667085; --card:#f6f8fa; --border:#d0d5dd;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark){
      :root{
        --bg:#0b0b0b; --fg:#eee; --muted:#98a2b3; --card:#14171a; --border:#2a2e33;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;background:var(--bg);color:var(--fg);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      line-height:1.35;
      padding-bottom:env(safe-area-inset-bottom)
    }

    header{
      position:sticky;top:0;z-index:50;
      background:linear-gradient(180deg,var(--brand),var(--brand-2));
      color:#fff;
      padding:calc(.6rem + env(safe-area-inset-top)) 1rem .6rem 1rem;
      display:flex;align-items:center;gap:.75rem;
      box-shadow:0 2px 12px rgba(0,0,0,.12)
    }
    header .logo{width:28px;height:28px;border-radius:6px;background:#fff2;display:inline-block}
    header h1{margin:0;font-size:1.1rem}

    main{max-width:960px;margin:0 auto;padding:1rem;padding-bottom:4.5rem}

    fieldset{
      border:1px solid var(--border);
      border-radius:.8rem;
      background:var(--card);
      padding:1rem;margin:0 0 1rem
    }
    legend{font-weight:700;padding:0 .5rem}

    label{display:block;margin:.55rem 0 .25rem}
    input,select{
      width:100%;padding:.65rem .75rem;font-size:1rem;
      border:1px solid var(--border);
      border-radius:.6rem;background:#fff;outline:none
    }
    @media (prefers-color-scheme: dark){
      input,select{background:#0e0e10;color:var(--fg)}
    }

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
    @media (max-width:820px){ .row3{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row3{grid-template-columns:1fr} .row2{grid-template-columns:1fr} }

    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.8rem}
    .btn{
      border:none;border-radius:.6rem;padding:.7rem 1rem;font-size:1rem;
      display:inline-flex;align-items:center;gap:.5rem;cursor:pointer
    }
    .btn.primary{background:var(--brand);color:#fff}
    .btn.secondary{background:#f28c2a;color:#fff}
    .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}

    .result{
      margin-top:.9rem;padding:1rem;border-radius:.8rem;background:#fff;
      border:1px dashed var(--border);
      display:flex;align-items:center;justify-content:center;text-align:center
    }
    @media (prefers-color-scheme: dark){ .result{background:#0e0e10} }
    .result h2{margin:0;font-size:clamp(1.6rem,4vw,2.2rem);font-weight:800;color:var(--brand)}
    .result small{display:block;color:var(--muted);margin-top:.25rem}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.55rem;text-align:left}
    thead th{background:#fff3e8}
    @media (prefers-color-scheme: dark){ thead th{background:#24170a;color:#fed8b4} }

    /* Tabbar (3 pestañas) */
    .tabbar{
      position:fixed;left:0;right:0;bottom:0;z-index:9999;
      background:var(--bg);
      border-top:1px solid var(--border);
      padding:.35rem calc(.6rem + env(safe-area-inset-bottom)) .35rem .6rem;
      display:grid;grid-template-columns:repeat(3,1fr);gap:.25rem
    }
    .tabbar button{
      appearance:none;border:none;background:transparent;color:#667085;
      display:flex;flex-direction:column;align-items:center;justify-content:center;
      gap:.25rem;padding:.5rem 0;border-radius:.5rem;cursor:pointer;font-size:.9rem
    }
    .tabbar button.active{color:var(--brand);font-weight:700;background:#fff7ef}
    @media (prefers-color-scheme: dark){ .tabbar button.active{background:#1b140c} }

    section.tab{display:none}
    section.tab.active{display:block}

    .hidden{display:none !important}
    .muted{color:var(--muted);font-size:.95rem}

    /* ===== Loader estilo iPhone ===== */
    #appLoader{
      position:fixed; inset:0; z-index:99999;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(180deg, #fdf7f3, #fff2e5);
      transition:opacity .35s ease, visibility .35s ease;
    }
    @media (prefers-color-scheme: dark){
      #appLoader{ background:linear-gradient(180deg, #0f0c08, #140f0a); }
    }
    #appLoader.hidden{ opacity:0; visibility:hidden; }
    .loader-card{
      width:min(280px, 70vw);
      padding:28px 24px;
      border-radius:24px;
      background:rgba(255,255,255,0.88);
      box-shadow:0 12px 40px rgba(0,0,0,.18);
      display:flex; flex-direction:column; align-items:center; gap:16px;
      backdrop-filter:saturate(140%) blur(6px);
      border:1px solid #ffd2ad;
    }
    @media (prefers-color-scheme: dark){
      .loader-card{ background:rgba(22,24,28,0.84); box-shadow:0 12px 40px rgba(0,0,0,.42); border-color:#3a2a18; }
    }
    .loader-icon{
      width:84px; height:84px; object-fit:cover; border-radius:18px;
      box-shadow:0 6px 16px rgba(0,0,0,.18);
      transform:scale(.96);
      animation:pop .5s cubic-bezier(.2,.8,.2,1) .1s both;
      border:2px solid #fff6;
    }
    @keyframes pop{ from{ transform:scale(.92); opacity:.6; } to{ transform:scale(1.00); opacity:1; } }
    .loader-spinner{
      width:34px; height:34px; border-radius:50%;
      border:3px solid rgba(120,120,120,.28);
      border-top-color:var(--brand);
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{ to { transform:rotate(360deg); } }
    .loader-text{
      font:500 14px/1 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:#333; letter-spacing:.2px;
    }
    @media (prefers-color-scheme: dark){ .loader-text{ color:#d8d8d8; } }
  </style>
</head>

<body>
  <header>
    <span class="logo" aria-hidden="true"></span>
    <h1>Shotcrete Calc</h1>
  </header>

  <!-- ===== Splash / Loader ===== -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <img class="loader-icon" alt="Shotcrete icon"
           src="https://raw.githubusercontent.com/Clauramarcelo/shotcrete-calc/main/Mixer.jpg" />
      <div class="loader-spinner" aria-label="Cargando"></div>
      <div class="loader-text">Cargando…</div>
    </div>
  </div>

  <main>
    <!-- ===== 1) CALCULO m3 ===== -->
    <section id="tab-calculo" class="tab active" aria-labelledby="btn-calculo">
      <fieldset>
        <legend>Calculo m3</legend>

        <div class="actions" style="margin-bottom:.4rem">
          <span class="muted">Modo:</span>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoQuick" value="tunnel" checked> Avance (túnel)
          </label>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoQuick" value="wall"> Resane (hastial)
          </label>
        </div>

        <div class="row3">
          <div><label for="qA">Ancho (A) — m</label><input id="qA" type="text" inputmode="decimal"></div>
          <div><label for="qH">Altura (H) — m</label><input id="qH" type="text" inputmode="decimal"></div>
          <div><label for="qL">Largo (L) — m</label><input id="qL" type="text" inputmode="decimal"></div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="qSac">Frente de sacrificio — m³ (auto)</label>
            <input id="qSac" type="text" inputmode="decimal" readonly>
          </div>
          <div>
            <label for="qConst">Constante (m²/m³)</label>
            <input id="qConst" type="text" inputmode="decimal" value="11.5">
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="qCalcular" type="button">Calcular</button>
          <button class="btn ghost" id="qLimpiar" type="button">Limpiar</button>
        </div>

        <div id="qOut" class="result" aria-live="polite">
          <h2>—</h2><small id="qMode">Selecciona modo y completa los datos.</small>
        </div>
      </fieldset>
    </section>

    <!-- ===== 2) REGISTROS ===== -->
    <section id="tab-registros" class="tab" aria-labelledby="btn-registros">
      <fieldset>
        <legend>Calculadora de Registros</legend>

        <div class="actions" style="margin-bottom:.4rem">
          <span class="muted">Modo:</span>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoRegCalc" value="tunnel" checked> Avance (túnel)
          </label>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoRegCalc" value="wall"> Resane (hastial)
          </label>
        </div>

        <div class="row3">
          <div><label for="rA">Ancho (A) — m</label><input id="rA" type="text" inputmode="decimal"></div>
          <div><label for="rH">Altura (H) — m</label><input id="rH" type="text" inputmode="decimal"></div>
          <div><label for="rL">Largo (L) — m</label><input id="rL" type="text" inputmode="decimal"></div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="rSac">Frente de sacrificio — m³ (auto)</label>
            <input id="rSac" type="text" inputmode="decimal" readonly>
          </div>
          <div>
            <label for="rConst">Constante (m²/m³)</label>
            <input id="rConst" type="text" inputmode="decimal" value="11.5">
          </div>
        </div>

        <div class="actions">
          <button class="btn primary" id="rCalcBtn" type="button">Calcular</button>
        </div>

        <div id="rOut" class="result" aria-live="polite">
          <h2>—</h2><small id="rMode">Primero calcula; luego podrás registrar la actividad.</small>
        </div>
      </fieldset>

      <!-- Formulario de registro -->
      <fieldset id="regForm" class="hidden">
        <legend>Registro de actividad</legend>

        <div class="row3">
          <div><label for="regFecha">Fecha</label><input id="regFecha" type="date" /></div>
          <div><label for="regNivel">Nivel</label><input id="regNivel" type="text" /></div>
          <div><label for="regLabor">Labor</label><input id="regLabor" type="text" /></div>
        </div>

        <div class="row3" style="margin-top:.6rem">
          <div><label for="regRobot">N° Robot</label><input id="regRobot" type="text" /></div>
          <div><label for="regPresion">Presión de aire (bar)</label><input id="regPresion" type="text" inputmode="decimal" placeholder="Ej. xx bar" /></div>
          <div>
            <label for="regUso">USO</label>
            <select id="regUso">
              <option value="" selected disabled>Selecciona…</option>
              <option value="NIC">NIC</option>
              <option value="REH">REH</option>
              <option value="REP">REP</option>
              <option value="OPE">OPE</option>
            </select>
          </div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="regTurno">Turno</label>
            <select id="regTurno">
              <option value="" selected disabled>Selecciona…</option>
              <option value="Día">Día</option>
              <option value="Noche">Noche</option>
            </select>
          </div>
          <div>
            <label for="regObs">Observaciones</label>
            <input id="regObs" type="text" />
          </div>
        </div>

        <div class="actions" style="align-items:end; justify-content:flex-end;">
          <button class="btn primary" id="regGuardarBtn" type="button">Registrar</button>
          <button class="btn secondary" id="goTablasBtn" type="button">Ir a Tablas</button>
        </div>

        <p id="regMsg" class="muted" style="margin-top:.4rem"></p>
      </fieldset>
    </section>

    <!-- ===== 3) TABLAS ===== -->
    <section id="tab-tablas" class="tab" aria-labelledby="btn-tablas">
      <fieldset>
        <legend>Tabla de registros (CSV)</legend>

        <div class="actions">
          <button class="btn primary" id="tbl3ExportCSV" type="button">Exportar a CSV</button>
          <button class="btn ghost" id="tbl3Refrescar" type="button">Refrescar</button>
          <button class="btn secondary" id="tbl3BorrarTodo" type="button">Borrar todo</button>
        </div>

        <table id="tbl3">
          <thead>
            <tr>
              <th>#</th><th>Fecha</th><th>Nivel</th><th>Labor</th><th>N° Robot</th>
              <th>Presión (bar)</th><th>USO</th><th>Turno</th><th>Obs.</th>
              <th>Modo</th><th>m³</th><th>Const.</th><th>Sac.</th><th>A/H/L</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </section>
  </main>

  <!-- Tab bar (solo 3 pestañas) -->
  <nav class="tabbar" role="tablist" aria-label="Navegación">
    <button type="button" id="btn-calculo" class="active" role="tab"
      aria-controls="tab-calculo" aria-selected="true"
      onclick="switchTab('tab-calculo', this)">Calculo m3</button>

    <button type="button" id="btn-registros" role="tab"
      aria-controls="tab-registros" aria-selected="false"
      onclick="switchTab('tab-registros', this)">Registros</button>

    <button type="button" id="btn-tablas" role="tab"
      aria-controls="tab-tablas" aria-selected="false"
      onclick="switchTab('tab-tablas', this)">Tablas</button>
  </nav>

  <script>
    /* ===== Tabs ===== */
    function switchTab(targetId, btnEl){
      try{
        document.querySelectorAll('.tabbar button').forEach(b=>{
          const active = (b === btnEl);
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', active ? 'true' : 'false');
        });

        document.querySelectorAll('section.tab').forEach(sec=>{
          sec.classList.toggle('active', sec.id === targetId);
        });

        if (targetId === 'tab-calculo') { document.getElementById('qA')?.focus({preventScroll:true}); }
        if (targetId === 'tab-registros'){ document.getElementById('rA')?.focus({preventScroll:true}); }
        if (targetId === 'tab-tablas') { renderTbl3(); }
      }catch(err){
        console.error('switchTab error:', err);
        alert('Ocurrió un error al cambiar de pestaña. Revisa la consola (F12).');
      }
    }

    /* ===== Utilidades ===== */
    function parseDec(txt){
      if (typeof txt !== 'string') return NaN;
      const s = txt.trim().replace(',', '.');
      if (s === '') return NaN;
      return Number(s);
    }
    const fmt1 = (n) => Number(n).toFixed(1);
    const todayStr = () => new Date().toISOString().slice(0,10);

    /* ===== Frente de sacrificio (AUTO)
       Fórmula: ((A * (H - 2)) * 0.9) / 14
    */
    function calcFrenteSacrificio(A, H){
      const hEff = Math.max(0, H - 2);
      return (A * hEff * 0.9) / 14;
    }

    /* ===== Pestaña 1: Calculo m3 ===== */
    const qA=document.getElementById('qA'), qH=document.getElementById('qH'), qL=document.getElementById('qL');
    const qSac=document.getElementById('qSac'), qConst=document.getElementById('qConst');
    const qOutH2=document.querySelector('#qOut h2'), qOutMode=document.getElementById('qMode');
    const qRadios=document.querySelectorAll('input[name="modoQuick"]');

    function nombreModoQuick(){
      const m=[...qRadios].find(r=>r.checked)?.value ?? 'tunnel';
      return m==='tunnel' ? 'Avance' : 'Resane';
    }

    function calcularQuick(){
      const A=parseDec(qA.value), H=parseDec(qH.value), L=parseDec(qL.value);
      const C=parseDec(qConst.value || '11.5');
      const m=[...qRadios].find(r=>r.checked)?.value ?? 'tunnel';

      if (!isFinite(L) || !isFinite(H) || !isFinite(C) || C<=0){
        qOutH2.textContent='—';
        qOutMode.textContent='Completa los datos.';
        qSac.value='';
        return;
      }
      if (m==='tunnel' && !isFinite(A)){
        qOutH2.textContent='—';
        qOutMode.textContent='Completa A, H y L.';
        qSac.value='';
        return;
      }

      // Sacrificio AUTO solo para túnel
      let Sac=0;
      if (m==='tunnel' && isFinite(A) && isFinite(H)){
        Sac = calcFrenteSacrificio(A,H);
        qSac.value = Sac.toFixed(2);
      } else {
        qSac.value='';
        Sac=0;
      }

      // Cálculo base original
      let m3_base=0;
      if (m==='tunnel'){
        const pp=(H*2)+A, pa=pp*0.9, al=pa*L;
        m3_base=al/C;
      } else {
        m3_base=(L*H)/C;
      }

      const m3_total=m3_base + Sac;
      qOutH2.textContent = `${nombreModoQuick()}: ${fmt1(m3_total)} m³`;
      qOutMode.textContent = '';
    }

    document.getElementById('qCalcular')?.addEventListener('click', calcularQuick);

    document.getElementById('qLimpiar')?.addEventListener('click', ()=>{
      qA.value=''; qH.value=''; qL.value='';
      qSac.value='';
      qConst.value='11.5';
      document.querySelector('input[name="modoQuick"][value="tunnel"]').checked=true;
      qOutH2.textContent='—';
      qOutMode.textContent='Selecciona modo y completa los datos.';
      qA.focus();
    });

    [qA,qH,qL,qConst,...qRadios].forEach(el=>{
      el?.addEventListener('input', ()=>{
        const m=[...qRadios].find(r=>r.checked)?.value ?? 'tunnel';
        const wallReady=qH.value.trim() && qL.value.trim();
        const tunnelReady=qA.value.trim() && wallReady;
        const ready=(m==='wall') ? wallReady : tunnelReady;
        if (ready) calcularQuick();
        else {
          qOutH2.textContent='—';
          qOutMode.textContent='Selecciona modo y completa los datos.';
          qSac.value='';
        }
      });
      el?.addEventListener('keydown', ev=>{ if(ev.key==='Enter') calcularQuick(); });
    });

    /* ===== Pestaña 2: Registros ===== */
    const rA=document.getElementById('rA'), rH=document.getElementById('rH'), rL=document.getElementById('rL');
    const rSac=document.getElementById('rSac'), rConst=document.getElementById('rConst');
    const rOutH2=document.querySelector('#rOut h2'), rOutMode=document.getElementById('rMode');
    const rRadios=document.querySelectorAll('input[name="modoRegCalc"]');
    const rCalcBtn=document.getElementById('rCalcBtn');
    const regForm=document.getElementById('regForm'), regMsg=document.getElementById('regMsg');

    function nombreModoReg(){
      const m=[...rRadios].find(r=>r.checked)?.value ?? 'tunnel';
      return m==='tunnel' ? 'Avance' : 'Resane';
    }

    let lastRegCalc=null;

    function calcularReg(){
      const A=parseDec(rA.value), H=parseDec(rH.value), L=parseDec(rL.value);
      const C=parseDec(rConst.value || '11.5');
      const m=[...rRadios].find(r=>r.checked)?.value ?? 'tunnel';

      if (!isFinite(L) || !isFinite(H) || !isFinite(C) || C<=0){
        rOutH2.textContent='—';
        rOutMode.textContent='Completa los datos.';
        regForm.classList.add('hidden');
        lastRegCalc=null;
        rSac.value='';
        return false;
      }
      if (m==='tunnel' && !isFinite(A)){
        rOutH2.textContent='—';
        rOutMode.textContent='Completa A, H y L.';
        regForm.classList.add('hidden');
        lastRegCalc=null;
        rSac.value='';
        return false;
      }

      // Sacrificio AUTO solo para túnel
      let Sac=0;
      if (m==='tunnel' && isFinite(A) && isFinite(H)){
        Sac = calcFrenteSacrificio(A,H);
        rSac.value = Sac.toFixed(2);
      } else {
        rSac.value='';
        Sac=0;
      }

      // Cálculo base original
      let m3_base=0;
      if (m==='tunnel'){
        const pp=(H*2)+A, pa=pp*0.9, al=pa*L;
        m3_base=al/C;
      } else {
        m3_base=(L*H)/C;
      }

      const m3_total=m3_base + Sac;
      rOutH2.textContent = `${nombreModoReg()}: ${fmt1(m3_total)} m³`;
      rOutMode.textContent='';

      lastRegCalc={
        modo:nombreModoReg(),
        m3:Number(fmt1(m3_total)),
        A:(m==='tunnel' && isFinite(A)) ? A : null,
        H, L, C,
        Sac:Number(Sac.toFixed(2))
      };

      regForm.classList.remove('hidden');
      return true;
    }

    rCalcBtn?.addEventListener('click', calcularReg);

    /* ===== Guardar Registros (localStorage) ===== */
    const LS_REGS='sc_registros';
    function getRegs(){ try{ return JSON.parse(localStorage.getItem(LS_REGS)) ?? []; }catch{ return []; } }
    function setRegs(arr){ localStorage.setItem(LS_REGS, JSON.stringify(arr)); }

    const regFecha=document.getElementById('regFecha'), regNivel=document.getElementById('regNivel'), regLabor=document.getElementById('regLabor');
    const regRobot=document.getElementById('regRobot'), regPresion=document.getElementById('regPresion'),
          regUso=document.getElementById('regUso'), regTurno=document.getElementById('regTurno'), regObs=document.getElementById('regObs');
    const regGuardarBtn=document.getElementById('regGuardarBtn'), goTablasBtn=document.getElementById('goTablasBtn');

    function limpiarFormularioRegistro(){
      regFecha.value=todayStr();
      regNivel.value=''; regLabor.value=''; regRobot.value='';
      regPresion.value=''; regUso.value=''; regTurno.value=''; regObs.value='';
      regMsg.textContent='';
    }
    limpiarFormularioRegistro();

    regGuardarBtn?.addEventListener('click', ()=>{
      if(!lastRegCalc){ alert('Primero realiza el cálculo.'); return; }

      const fecha=regFecha.value || todayStr();
      const nivel=regNivel.value.trim();
      const labor=regLabor.value.trim();
      const robot=regRobot.value.trim();

      const presionRaw=regPresion.value.trim();
      let presion=parseFloat(presionRaw.replace(/[^0-9.,-]/g,''));
      presion=isNaN(presion)?NaN:presion;

      const uso=regUso.value;
      const turno=regTurno.value;
      const obs=regObs.value.trim();

      if(!fecha || !nivel || !labor || !robot || !isFinite(presion) || !uso || !turno){
        alert('Completa Fecha, Nivel, Labor, N° Robot, Presión (bar), USO y Turno.');
        return;
      }

      const regs=getRegs();
      regs.push({
        fecha, nivel, labor, robot,
        presion:Number(presion.toFixed(2)),
        uso, turno, obs,
        modo:lastRegCalc.modo, m3:lastRegCalc.m3, C:lastRegCalc.C, Sac:lastRegCalc.Sac,
        A:lastRegCalc.A, H:lastRegCalc.H, L:lastRegCalc.L
      });

      setRegs(regs);
      regMsg.textContent='Registro guardado. Revisa la pestaña “Tablas”.';
    });

    goTablasBtn?.addEventListener('click', ()=>{
      switchTab('tab-tablas', document.getElementById('btn-tablas'));
    });

    /* ===== Tablas + CSV ===== */
    const tbl3Body=document.querySelector('#tbl3 tbody');

    function renderTbl3(){
      const regs=getRegs();
      tbl3Body.innerHTML='';
      regs.forEach((r,i)=>{
        const tr=document.createElement('tr');
        const m3txt=(r.m3==null)?'—':fmt1(r.m3);
        const constxt=(r.C??'—');
        const sactxt=(r.Sac??'—');
        const ahltxt=(r.A??'—')+'/'+(r.H??'—')+'/'+(r.L??'—');

        tr.innerHTML=`
          <td>${i+1}</td><td>${r.fecha}</td><td>${r.nivel}</td><td>${r.labor}</td><td>${r.robot}</td>
          <td>${r.presion}</td><td>${r.uso??'—'}</td><td>${r.turno??'—'}</td><td>${r.obs??''}</td>
          <td>${r.modo??'—'}</td><td>${m3txt}</td><td>${constxt}</td><td>${sactxt}</td><td>${ahltxt}</td>
          <td><button class="btn ghost" type="button" data-i="${i}">Eliminar</button></td>
        `;
        tbl3Body.appendChild(tr);

        tr.querySelector('button')?.addEventListener('click', ()=>{
          const arr=getRegs();
          arr.splice(i,1);
          setRegs(arr);
          renderTbl3();
        });
      });
    }

    function toCSV(regs){
      const headers=['N','Fecha','Nivel','Labor','Nro Robot','Presion (bar)','USO','Turno','Observaciones','Modo','m3','Constante','Sacrificio','A','H','L'];
      const esc=(v)=>{ const s=(v==null)?'':String(v); return '"' + s.replace(/"/g,'""') + '"'; };
      const lines=[headers.join(',')];
      regs.forEach((r,i)=>{
        lines.push([
          i+1,r.fecha,r.nivel,r.labor,r.robot,r.presion,r.uso,r.turno,r.obs??'',r.modo,
          (r.m3==null?'':fmt1(r.m3)),r.C,r.Sac,r.A,r.H,r.L
        ].map(esc).join(','));
      });
      return lines.join('\r\n');
    }

    document.getElementById('tbl3ExportCSV')?.addEventListener('click', ()=>{
      const regs=getRegs();
      if(!regs.length){ alert('No hay registros para exportar.'); return; }
      const csv=toCSV(regs);
      const blob=new Blob([csv],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url;
      a.download=`shotcrete-registros-${Date.now()}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    });

    document.getElementById('tbl3Refrescar')?.addEventListener('click', ()=>{ renderTbl3(); });

    document.getElementById('tbl3BorrarTodo')?.addEventListener('click', ()=>{
      if(confirm('¿Borrar TODOS los registros?')){
        localStorage.removeItem(LS_REGS);
        renderTbl3();
      }
    });

    /* ===== Loader control ===== */
    (function(){
      const loader = document.getElementById('appLoader');
      if(!loader) return;
      const safetyHide = setTimeout(hideLoader, 6000);
      window.addEventListener('load', hideLoader);
      function hideLoader(){
        clearTimeout(safetyHide);
        loader.classList.add('hidden');
        setTimeout(()=>{ loader.style.display='none'; }, 400);
      }
    })();

    /* ===== SW register ===== */
    (function(){
      if('serviceWorker' in navigator){
        const swUrl='/shotcrete-calc/sw.js';
        window.addEventListener('load', ()=> {
          navigator.serviceWorker.register(swUrl).catch(()=>{});
        });
      }
    })();
  </script>
</body>
</html>
