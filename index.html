
<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Shotcrete Calc</title>

  <!-- PWA (GitHub Pages en sub-path) -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json">
  <meta name="theme-color" content="#0a84ff" />

  <style>
    :root{
      --brand:#0a84ff; --brand-2:#166ef2;
      --bg:#ffffff; --fg:#0b0b0b; --muted:#667085; --card:#f6f8fa; --border:#d0d5dd;
      color-scheme: light dark;
    }
    @media (prefers-color-scheme: dark){
      :root{ --bg:#0b0b0b; --fg:#eee; --muted:#98a2b3; --card:#14171a; --border:#2a2e33; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;line-height:1.35;padding-bottom:env(safe-area-inset-bottom)}

    header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,var(--brand),var(--brand-2));color:#fff;padding:calc(.6rem + env(safe-area-inset-top)) 1rem .6rem 1rem;display:flex;align-items:center;gap:.75rem;box-shadow:0 2px 12px rgba(0,0,0,.12)}
    header .logo{width:28px;height:28px;border-radius:6px;background:#fff2;display:inline-block}
    header h1{margin:0;font-size:1.1rem}

    main{max-width:960px;margin:0 auto;padding:1rem;padding-bottom:4.5rem}

    fieldset{border:1px solid var(--border);border-radius:.8rem;background:var(--card);padding:1rem;margin:0 0 1rem}
    legend{font-weight:700;padding:0 .5rem}
    label{display:block;margin:.55rem 0 .25rem}

    input,select{width:100%;padding:.65rem .75rem;font-size:1rem;border:1px solid var(--border);border-radius:.6rem;background:#fff;outline:none}
    @media (prefers-color-scheme: dark){ input,select{background:#0e0e10;color:var(--fg)} }

    .row2{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1rem}
    @media (max-width:820px){ .row3{grid-template-columns:1fr 1fr} }
    @media (max-width:560px){ .row3{grid-template-columns:1fr} .row2{grid-template-columns:1fr} }

    .actions{display:flex;flex-wrap:wrap;gap:.6rem;margin-top:.8rem}
    .btn{border:none;border-radius:.6rem;padding:.7rem 1rem;font-size:1rem;display:inline-flex;align-items:center;gap:.5rem;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff}
    .btn.secondary{background:#2f3b48;color:#fff}
    .btn.ghost{background:transparent;color:var(--brand);border:1px solid var(--brand)}

    .result{margin-top:.9rem;padding:1rem;border-radius:.8rem;background:#fff;border:1px dashed var(--border);display:flex;align-items:center;justify-content:center;text-align:center}
    @media (prefers-color-scheme: dark){ .result{background:#0e0e10} }
    .result h2{margin:0;font-size:clamp(1.6rem,4vw,2.2rem);font-weight:800;color:#0a84ff}
    .result small{display:block;color:var(--muted);margin-top:.25rem}

    table{width:100%;border-collapse:collapse}
    th,td{border:1px solid var(--border);padding:.55rem;text-align:left}
    thead th{background:#eef3ff}
    @media (prefers-color-scheme: dark){ thead th{background:#0f203a;color:#cfe0ff} }

    .tabbar{position:fixed;left:0;right:0;bottom:0;z-index:9999;background:var(--bg);border-top:1px solid var(--border);padding:.35rem calc(.6rem + env(safe-area-inset-bottom)) .35rem .6rem;display:grid;grid-template-columns:repeat(5,1fr);gap:.25rem}
    .tabbar button{appearance:none;border:none;background:transparent;color:#667085;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:.25rem;padding:.5rem 0;border-radius:.5rem;cursor:pointer;font-size:.9rem}
    .tabbar button.active{color:#0a84ff;font-weight:700;background:var(--card)}
    section.tab{display:none}
    section.tab.active{display:block}

    .hidden{display:none !important}
    .muted{color:var(--muted);font-size:.95rem}
  </style>
</head>
<body>
  <header>
    <span class="logo" aria-hidden="true"></span>
    <h1>Shotcrete Calc</h1>
  </header>

  <main>
    <!-- ===== 1) CALCULO m3 ===== -->
    <section id="tab-calculo" class="tab active" aria-labelledby="btn-calculo">
      <fieldset>
        <legend>Calculo m3</legend>

        <div class="actions" style="margin-bottom:.4rem">
          <span class="muted">Modo:</span>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoQuick" value="tunnel" checked> Avance (túnel)
          </label>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoQuick" value="wall"> Resane (hastial)
          </label>
        </div>

        <div class="row3">
          <div><label for="qA">Ancho (A) — m</label><input id="qA" type="text" inputmode="decimal"></div>
          <div><label for="qH">Altura (H) — m</label><input id="qH" type="text" inputmode="decimal"></div>
          <div><label for="qL">Largo (L) — m</label><input id="qL" type="text" inputmode="decimal"></div>
        </div>
        <div class="row2" style="margin-top:.6rem">
          <div><label for="qSac">Frente de sacrificio — m³</label><input id="qSac" type="text" inputmode="decimal"></div>
          <div><label for="qConst">Constante (m²/m³)</label><input id="qConst" type="text" inputmode="decimal" value="11.5"></div>
        </div>

        <div class="actions">
          <button class="btn primary" id="qCalcular" type="button">Calcular</button>
          <button class="btn ghost" id="qLimpiar" type="button">Limpiar</button>
        </div>

        <div id="qOut" class="result" aria-live="polite">
          <h2>—</h2><small id="qMode">Selecciona modo y completa los datos.</small>
        </div>
      </fieldset>
    </section>

    <!-- ===== 2) REGISTROS ===== -->
    <section id="tab-registros" class="tab" aria-labelledby="btn-registros">
      <fieldset>
        <legend>Calculadora de Registros</legend>

        <div class="actions" style="margin-bottom:.4rem">
          <span class="muted">Modo:</span>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoRegCalc" value="tunnel" checked> Avance (túnel)
          </label>
          <label style="display:inline-flex;align-items:center;gap:.35rem;margin-left:.5rem">
            <input type="radio" name="modoRegCalc" value="wall"> Resane (hastial)
          </label>
        </div>

        <div class="row3">
          <div><label for="rA">Ancho (A) — m</label><input id="rA" type="text" inputmode="decimal"></div>
          <div><label for="rH">Altura (H) — m</label><input id="rH" type="text" inputmode="decimal"></div>
          <div><label for="rL">Largo (L) — m</label><input id="rL" type="text" inputmode="decimal"></div>
        </div>
        <div class="row2" style="margin-top:.6rem">
          <div><label for="rSac">Frente de sacrificio — m³</label><input id="rSac" type="text" inputmode="decimal"></div>
          <div><label for="rConst">Constante (m²/m³)</label><input id="rConst" type="text" inputmode="decimal" value="11.5"></div>
        </div>

        <div class="actions">
          <button class="btn primary" id="rCalcBtn" type="button">Calcular</button>
        </div>

        <div id="rOut" class="result" aria-live="polite">
          <h2>—</h2><small id="rMode">Primero calcula; luego podrás registrar la actividad.</small>
        </div>
      </fieldset>

      <!-- Formulario de registro -->
      <fieldset id="regForm" class="hidden">
        <legend>Registro de actividad</legend>
        <div class="row3">
          <div><label for="regFecha">Fecha</label><input id="regFecha" type="date" /></div>
          <div><label for="regNivel">Nivel</label><input id="regNivel" type="text" /></div>
          <div><label for="regLabor">Labor</label><input id="regLabor" type="text" /></div>
        </div>
        <div class="row3" style="margin-top:.6rem">
          <div><label for="regRobot">N° Robot</label><input id="regRobot" type="text" /></div>
          <div><label for="regPresion">Presión de aire (bar)</label><input id="regPresion" type="text" inputmode="decimal" placeholder="Ej. xx bar" /></div>
          <div><label for="regUso">USO</label>
            <select id="regUso">
              <option value="" selected disabled>Selecciona…</option>
              <option value="NIC">NIC</option>
              <option value="REH">REH</option>
              <option value="REP">REP</option>
              <option value="OPE">OPE</option>
            </select>
          </div>
        </div>
        <div class="row2" style="margin-top:.6rem">
          <div>
            <label for="regTurno">Turno</label>
            <select id="regTurno">
              <option value="" selected disabled>Selecciona…</option>
              <option value="Día">Día</option>
              <option value="Noche">Noche</option>
            </select>
          </div>
          <div>
            <label for="regObs">Observaciones</label>
            <input id="regObs" type="text" />
          </div>
        </div>
        <div class="actions" style="align-items:end; justify-content:flex-end;">
          <button class="btn primary" id="regGuardarBtn" type="button">Registrar</button>
          <button class="btn secondary" id="goTablasBtn" type="button" onclick="switchTab('tab-tablas', document.getElementById('btn-tablas'))">Ir a Tablas</button>
        </div>
        <p id="regMsg" class="muted" style="margin-top:.4rem"></p>
      </fieldset>
    </section>

    <!-- ===== 3) TABLAS ===== -->
    <section id="tab-tablas" class="tab" aria-labelledby="btn-tablas">
      <fieldset>
        <legend>Tabla de registros (CSV)</legend>
        <div class="actions">
          <button class="btn primary"  id="tbl3ExportCSV" type="button">Exportar a CSV</button>
          <button class="btn ghost"    id="tbl3Refrescar"  type="button">Refrescar</button>
          <button class="btn secondary"id="tbl3BorrarTodo" type="button">Borrar todo</button>
        </div>
        <table id="tbl3">
          <thead>
            <tr>
              <th>#</th><th>Fecha</th><th>Nivel</th><th>Labor</th><th>N° Robot</th>
              <th>Presión (bar)</th><th>USO</th><th>Turno</th><th>Obs.</th>
              <th>Modo</th><th>m³</th><th>Const.</th><th>Sac.</th><th>A/H/L</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </section>

    <!-- ===== 4) DASHBOARD ===== -->
    <section id="tab-dashboard" class="tab" aria-labelledby="btn-dashboard">
      <fieldset>
        <legend>Producción (Labor vs m³)</legend>
        <div class="actions">
          <button class="btn primary" id="btnRenderProduccion" type="button">Actualizar gráfico</button>
        </div>
        <canvas id="chartProduccion" width="900" height="360"
                style="max-width:100%; background:var(--card); border:1px solid var(--border); border-radius:.6rem;"></canvas>
        <p class="muted" style="margin-top:.5rem">Suma de m³ por <strong>Labor</strong>.</p>
      </fieldset>

      <fieldset>
        <legend>Ensayos — Resistencia (MPa) vs Tiempo (h)</legend>
        <div class="row2" style="align-items:end;">
          <div>
            <label for="ensayoSelect">Selecciona un ensayo</label>
            <select id="ensayoSelect"></select>
            <p class="muted" id="ensayoMeta" style="margin:.35rem 0 0;"></p>
          </div>
          <div class="actions" style="justify-content:flex-end;">
            <button class="btn primary" id="btnRenderEnsayo" type="button">Dibujar curva</button>
            <label style="display:flex; align-items:center; gap:.35rem; margin-left:.5rem;">
              <input type="checkbox" id="chkGuias" checked>
              <span>Guías de referencia</span>
            </label>
          </div>
        </div>

        <canvas id="chartEnsayo" width="900" height="420"
                style="max-width:100%; background:#fff; border:1px solid var(--border); border-radius:.6rem; margin-top:.6rem;"></canvas>
        <p class="muted" style="margin-top:.5rem">Ejes logarítmicos, grilla mayor/menor, guías opcionales y etiquetas.</p>
      </fieldset>
    </section>

    <!-- ===== 5) ENSAYOS ===== -->
    <section id="tab-ensayos" class="tab" aria-labelledby="btn-ensayos">
      <fieldset>
        <legend>Datos del ensayo</legend>
        <div class="row3">
          <div><label for="eLabor">Labor</label><input id="eLabor" type="text"></div>
          <div><label for="eNivel">Nivel</label><input id="eNivel" type="text"></div>
          <div><label for="eRobot">Robot</label><input id="eRobot" type="text"></div>
        </div>
        <p class="muted" style="margin-top:.35rem">Temperatura y Slump se registran en <strong>Registros</strong>.</p>
      </fieldset>

      <!-- Penetración (A) -->
      <fieldset>
        <legend>Penetración (método A) — 10 fuerzas por tiempo</legend>

        <div class="row2">
          <div><label for="pHoraIni">Hora inicial (hh:mm)</label><input id="pHoraIni" type="text" placeholder="ej. 23:00"></div>
          <div class="muted" style="display:flex;align-items:end">Ej.: 23:15 con 23:00 → hora acumulada = 0.25 h</div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div><label for="pHora">Hora de lectura (hh:mm)</label><input id="pHora" type="text" placeholder="ej. 23:15"></div>
          <div><label for="pFuerzas">10 Fuerzas (N), separadas por coma</label><input id="pFuerzas" type="text" placeholder="145,134,175,180,210,150,152,152,164,134"></div>
        </div>

        <div class="row2" style="margin-top:.6rem">
          <div><label for="pRestar">Restar (N)</label><input id="pRestar" type="text" inputmode="decimal" value="37"></div>
          <div><label for="pKPen">Dividir entre (N→MPa)</label><input id="pKPen" type="text" inputmode="decimal" value="526"></div>
        </div>

        <div class="actions">
          <button class="btn primary" id="pAdd" type="button">Añadir fila</button>
          <button class="btn ghost" id="pClear" type="button">Limpiar</button>
          <button class="btn secondary" id="pSave" type="button">Guardar ensayo (Penetración)</button>
        </div>

        <table id="tblPen">
          <thead>
            <tr>
              <th>#</th><th>Hora lectura</th><th>Hora acumulada (h)</th>
              <th>Fuerzas (10)</th><th>Promedio (N)</th><th>MPa = (Prom−37)/526</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>

      <!-- Hilti B -->
      <fieldset>
        <legend>Pull‑out (método Hilti B)</legend>
        <div class="row3">
          <div><label for="hHora">Hora lectura (hh:mm)</label><input id="hHora" type="text" placeholder="01:00"></div>
          <div><label for="hHoraAc">Hora acumulada (h)</label><input id="hHoraAc" type="text" inputmode="decimal" placeholder="1.00"></div>
          <div><label for="hPerforada">Parte perforada (mm)</label><input id="hPerforada" type="text" inputmode="decimal"></div>
        </div>
        <div class="row2" style="margin-top:.6rem">
          <div><label for="hPullN">Lectura pull‑out (N)</label><input id="hPullN" type="text" inputmode="decimal"></div>
          <div><label for="hOffset">Offset (+)</label><input id="hOffset" type="text" inputmode="decimal" value="2.7"></div>
          <div><label for="hDivisor">Divisor (/) → MPa</label><input id="hDivisor" type="text" inputmode="decimal" value="7.69"></div>
        </div>
        <div class="actions">
          <button class="btn primary" id="hAdd" type="button">Añadir fila</button>
          <button class="btn ghost" id="hClear" type="button">Limpiar</button>
          <button class="btn secondary" id="hSave" type="button">Guardar ensayo (Hilti)</button>
        </div>

        <table id="tblHilti">
          <thead>
            <tr>
              <th>#</th><th>Hora</th><th>h acumulada</th><th>Perforada (mm)</th><th>Pull‑out (N)</th>
              <th>Relación (N/mm)</th><th>Grupo h</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <p class="muted" style="margin-top:.35rem">MPa (por grupo h) = (PROM(Relación N/mm) + 2.7) / 7.69.</p>
      </fieldset>

      <!-- Resumen ensayos -->
      <fieldset>
        <legend>Ensayos guardados (resumen)</legend>
        <table id="tblEnsRes">
          <thead>
            <tr>
              <th>#</th><th>Tipo</th><th>Labor | Nivel | Robot</th>
              <th>MPa 1h</th><th>MPa 2h</th><th>MPa 3h</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </fieldset>
    </section>
  </main>

  <!-- Tab bar (onclick + switchTab) -->
  <nav class="tabbar" role="tablist" aria-label="Navegación">
    <button type="button" id="btn-calculo" class="active" role="tab" aria-controls="tab-calculo" aria-selected="true"
            onclick="switchTab('tab-calculo', this)">Calculo m3</button>

    <button type="button" id="btn-registros" role="tab" aria-controls="tab-registros" aria-selected="false"
            onclick="switchTab('tab-registros', this)">Registros</button>

    <button type="button" id="btn-tablas" role="tab" aria-controls="tab-tablas" aria-selected="false"
            onclick="switchTab('tab-tablas', this)">Tablas</button>

    <button type="button" id="btn-dashboard" role="tab" aria-controls="tab-dashboard" aria-selected="false"
            onclick="switchTab('tab-dashboard', this)">Dashboard</button>

    <button type="button" id="btn-ensayos" role="tab" aria-controls="tab-ensayos" aria-selected="false"
            onclick="switchTab('tab-ensayos', this)">Ensayos</button>
  </nav>

  <!-- ======= JavaScript ======= -->
  <script>
    /* ===== Globales: evitar doble declaración ===== */
    window.LS_ENSAYOS ||= 'sc_ensayos2';
    const LS_ENSAYOS = window.LS_ENSAYOS;
  </script>

  <script>
    /* ===== Cambio de pestañas ULTRA CONFIABLE ===== */
    function _switchTabImpl(targetId, btnEl){
      try{
        document.querySelectorAll('.tabbar button').forEach(b=>{
          const active=(b===btnEl);
          b.classList.toggle('active', active);
          b.setAttribute('aria-selected', active?'true':'false');
        });
        document.querySelectorAll('section.tab').forEach(sec=>{
          sec.classList.toggle('active', sec.id===targetId);
        });
        if (targetId==='tab-calculo')   { document.getElementById('qA')?.focus({preventScroll:true}); }
        if (targetId==='tab-registros'){ document.getElementById('rA')?.focus({preventScroll:true}); }
        if (targetId==='tab-tablas')    { window.renderTbl3?.(); }
        if (targetId==='tab-dashboard'){ window.renderDashboard?.(); }
        if (targetId==='tab-ensayos')   { window.renderEnsRes?.(); }
      }catch(err){
        console.error('switchTab error:', err);
        alert('Ocurrió un error al cambiar de pestaña. Revisa la consola (F12).');
      }
    }
    window.switchTab = _switchTabImpl;
  </script>

  <!-- ********* EL RESTO DEL SCRIPT: tus funciones de cálculo, tablas, dashboard y ensayos ********* -->
  <!-- (Mantén tus funciones tal cual las envié; solo asegúrate de NO declarar LS_ENSAYOS otra vez) -->

  <script>
    /* UTILIDADES, CALCULO m3, REGISTROS, TABLAS, DASHBOARD, ENSAYOS... (igual que el archivo anterior) */
    /* ... (omito aquí por brevedad, puedes pegar tu bloque entero anterior sin la redeclaración de LS_ENSAYOS) ... */

    /* ===== Service Worker ===== */
    (function(){
      if('serviceWorker' in navigator){
        const swUrl='/shotcrete-calc/sw.js';
        window.addEventListener('load', ()=>{ navigator.serviceWorker.register(swUrl).catch(()=>{}); });
      }
    })();
  </script>
</body>
</html>

