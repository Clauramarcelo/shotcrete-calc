<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Inspección de lanzado de Shotcrete</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- PWA (ajustado al sub-path del repo en GitHub Pages) -->
  <link rel="manifest" href="/shotcrete-calc/manifest.json">
  <!-- Si ya tienes icono, puedes añadir:
  <link rel="apple-touch-icon" href="/shotcrete-calc/icon-192.png">
  -->
  <meta name="theme-color" content="#0a84ff">

  <!-- Estilos: tema automático claro/oscuro + UI compacta + tabs lineales -->
  <style>
    :root {
      /* Paleta (modo claro) */
      --bg: #ffffff;
      --text: #0f0f10;
      --muted: #5c6170;
      --primary: #0a2cff;
      --primary-2: #4f7cff;
      --accent: #0a84ff;
      --warn: #ff5a5f;
      --panel: #f8f9fb;
      --border: #e1e5ee;
      --tab-hover: #f5f7ff;

      --font-size: 15px;          /* tamaño general reducido */
      --font-size-small: 13px;    /* tablas y notas */
      --radius: 8px;
    }

    /* Tema automático (oscuro) */
    @media (prefers-color-scheme: dark) {
      :root {
        --bg: #0f1320;
        --text: #f2f4fb;
        --muted: #c0c6d8;
        --primary: #8ab4ff;
        --primary-2: #517abf;
        --accent: #8ab4ff;
        --warn: #ff6b6b;
        --panel: #1a2035;
        --border: #2a3353;
        --tab-hover: #1d2540;
      }
    }

    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-size: var(--font-size);
    }
    .container { margin: 16px; max-width: 980px; }

    /* Encabezado */
    .brand-header {
      background: linear-gradient(90deg, var(--primary) 0%, var(--primary-2) 100%);
      color: #fff;
      padding: 16px;
      border-bottom: 3px solid var(--accent);
      text-align: center;
    }
    .brand-title { margin: 0; font-size: 1.4rem; font-weight: 800; }
    .brand-sub   { margin: 4px 0 0 0; font-size: 0.85rem; opacity: 0.9; font-style: italic; }

    /* Tabs lineales */
    .tabs {
      display: flex; gap: 2px; flex-wrap: wrap;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; z-index: 5;
      background: var(--bg);
    }
    .tab-btn {
      appearance: none; border: none; background: transparent;
      color: var(--muted); padding: 10px 14px; cursor: pointer;
      border-bottom: 2px solid transparent; font-weight: 600; font-size: 14px;
    }
    .tab-btn:hover { background: var(--tab-hover); }
    .tab-btn[aria-selected="true"] {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab-content { display: none; padding-top: 12px; }
    .tab-content.active { display: block; }

    /* Formulario */
    label { display: block; margin-top: 10px; font-weight: 600; font-size: 14px; color: var(--text); }
    input, select, textarea {
      width: 100%; padding: 8px; font-size: 14px;
      border: 1px solid var(--border); border-radius: 6px;
      background: #fff; color: #000;
    }
    @media (prefers-color-scheme: dark) {
      input, select, textarea { background: #12172b; color: #e8eaf1; border-color: #2a3353; }
      option { background: #12172b; color: #e8eaf1; }
    }
    textarea { min-height: 60px; resize: vertical; }

    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .row3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    @media (max-width: 560px) { .row2, .row3 { grid-template-columns: 1fr; } }

    .actions { display: flex; gap: 10px; margin-top: 14px; flex-wrap: wrap; }
    button {
      padding: 10px; font-size: 14px;
      background: var(--accent); color: #fff; border: 0; border-radius: 6px; cursor: pointer;
    }
    button.secondary { background: #eef2ff; color: var(--primary); border: 1px solid var(--border); }
    .btn-danger { background: var(--warn); }

    .panel {
      margin-top: 14px; padding: 12px; border: 1px solid var(--border); border-radius: var(--radius);
      background: var(--panel);
    }
    .result-title { font-size: 0.85rem; color: var(--muted); }
    .result-value { font-size: 1.4rem; font-weight: 700; margin: 6px 0; color: var(--accent); }
    .summary { color: var(--text); font-size: 0.85rem; white-space: pre-line; }
    .error { color: var(--warn); font-size: 0.85rem; margin-top: 8px; }

    /* Tablas */
    .table-wrap { margin-top: 8px; border: 1px solid var(--border); border-radius: 6px; overflow: auto; }
    table { width: 100%; border-collapse: collapse; font-size: var(--font-size-small); background: var(--bg); color: var(--text); }
    th, td { padding: 8px; border-bottom: 1px solid var(--border); text-align: left; vertical-align: top; }
    th { background: #eef2ff; color: var(--primary); position: sticky; top: 0; }
    @media (prefers-color-scheme: dark) { th { background: #202a47; } }
    tr:hover { background: #f7f9ff; }
    @media (prefers-color-scheme: dark) { tr:hover { background: #1d2540; } }
    .no-data { padding: 12px; color: var(--muted); }

    /* Gráfico */
    .chart-card {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--panel);
      padding: 10px;
    }
    .chart-title { font-size: 0.95rem; color: var(--muted); margin: 0 0 6px; }
    canvas { width: 100%; height: 260px; }
  </style>
</head>
<body>
  <!-- Encabezado -->
  <header class="brand-header">
    <h1 class="brand-title">Inspección de lanzado de Shotcrete</h1>
    <p class="brand-sub">Área de Control de Calidad</p>
  </header>

  <main class="container">
    <!-- Tabs (Dashboard en 4ª pestaña) -->
    <div class="tabs" role="tablist" aria-label="Navegación de pestañas">
      <button id="tab-rapido-btn"    class="tab-btn" role="tab" aria-controls="tab-rapido"    aria-selected="true">Cálculo rápido</button>
      <button id="tab-ingreso-btn"   class="tab-btn" role="tab" aria-controls="tab-ingreso"   aria-selected="false">Ingreso / Calcular</button>
      <button id="tab-registros-btn" class="tab-btn" role="tab" aria-controls="tab-registros" aria-selected="false">Registros</button>
      <button id="tab-dashboard-btn" class="tab-btn" role="tab" aria-controls="tab-dashboard" aria-selected="false">Dashboard</button>
    </div>

    <!-- 1) Cálculo rápido -->
    <section id="tab-rapido" class="tab-content active" role="tabpanel" aria-labelledby="tab-rapido-btn">
      <p class="desc" style="color:var(--muted); font-size:var(--font-size-small); margin:0 0 6px;">
        Ingrese A, H, L y el Frente de sacrificio. Factor fijo: <strong>11.5</strong>. Total = m³ base + frente.
      </p>

      <div class="row3">
        <div><label>Ancho (A) [m]  <input id="r-ancho"  type="number" step="0.01" placeholder="0.00" /></label></div>
        <div><label>Altura (H) [m] <input id="r-altura"  type="number" step="0.01" placeholder="0.00" /></label></div>
        <div><label>Largo (L) [m]  <input id="r-largo"   type="number" step="0.01" placeholder="0.00" /></label></div>
      </div>

      <label>Frente de sacrificio (m³)
        <input id="r-frente" type="number" step="0.001" value="0" placeholder="0.000" />
      </label>

      <div class="actions">
        <button id="r-btn-calcular">Calcular m³</button>
        <button class="secondary" id="r-btn-limpiar">Limpiar</button>
      </div>

      <div id="r-msg" class="error" role="alert" aria-live="polite"></div>

      <div class="panel" id="r-panel" style="display:none;">
        <div class="result-title">Resultado</div>
        <div class="result-value" id="r-valor">0.000 m³</div>
        <div class="summary" id="r-resumen">—</div>
      </div>
    </section>

    <!-- 2) Ingreso / Calcular -->
    <section id="tab-ingreso" class="tab-content" role="tabpanel" aria-labelledby="tab-ingreso-btn">
      <label>Fecha <input id="fecha" type="date" /></label>

      <div class="row2">
        <div><label>Labor <input id="labor" placeholder="Nombre de la labor" /></label></div>
        <div><label>Nivel (Nv.) <input id="nivel" placeholder="Nivel" /></label></div>
      </div>

      <div class="row3">
        <div><label>Ancho (A) [m] <input id="ancho" type="number" step="0.01" placeholder="0.00" /></label></div>
        <div><label>Largo (L) [m] <input id="largo" type="number" step="0.01" placeholder="0.00" /></label></div>
        <div><label>Altura (H) [m] <input id="altura" type="number" step="0.01" placeholder="0.00" /></label></div>
      </div>

      <label>Factor (por defecto 11.5) <input id="factor" type="number" step="0.01" value="11.5" /></label>
      <label>Frente de sacrificio (m³) <input id="frente" type="number" step="0.001" value="0" placeholder="0.000" /></label>

      <div class="row2">
        <div><label>Presión (bar) <input id="presion_bar" type="number" step="0.01" min="0" placeholder="0.00" /></label></div>
        <div><label>Guardia <input id="guardia" placeholder="Ej.: A / B / C / Día / Noche" /></label></div>
      </div>

      <div class="row2">
        <div><label>USO
          <select id="uso">
            <option value="REP">REP</option><option value="REO">REO</option>
            <option value="REH">REH</option><option value="OPE">OPE</option>
          </select>
        </label></div>
        <div><label>Observaciones <textarea id="observaciones" placeholder="Notas u observaciones"></textarea></label></div>
      </div>

      <div class="actions">
        <button id="btn-calcular">Calcular m³</button>
        <button class="secondary" id="btn-guardar">Guardar registro</button>
        <button class="secondary" id="btn-limpiar">Limpiar</button>
      </div>

      <div id="msg" class="error" role="alert" aria-live="polite"></div>

      <div class="panel" id="panel-resultado" style="display:none;">
        <div class="result-title">Resultado</div>
        <div class="result-value" id="valor-m3">0.000 m³</div>
        <div class="summary" id="resumen">—</div>
      </div>
    </section>

    <!-- 3) Registros -->
    <section id="tab-registros" class="tab-content" role="tabpanel" aria-labelledby="tab-registros-btn">
      <div class="actions" style="justify-content:flex-end;">
        <button class="secondary" id="btn-csv">Exportar CSV</button>
        <button class="btn-danger" id="btn-borrar-todo" title="Borrar todos los registros">Borrar todo</button>
      </div>
      <div class="table-wrap">
        <table aria-label="Registros guardados">
          <thead>
            <tr>
              <th>Fecha</th><th>Labor</th><th>Nivel</th><th>Guardia</th><th>USO</th>
              <th>A</th><th>L</th><th>H</th><th>Factor</th><th>m³ base</th><th>Frente</th><th>m³ total</th>
              <th>Presión (bar)</th><th>Obs.</th><th>Acción</th>
            </tr>
          </thead>
          <tbody id="tbody-registros">
            <tr class="no-data"><td colspan="15">Sin registros guardados</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- 4) Dashboard -->
    <section id="tab-dashboard" class="tab-content" role="tabpanel" aria-labelledby="tab-dashboard-btn">
      <p class="desc" style="color:var(--muted); font-size:var(--font-size-small); margin:0 0 6px;">
        Vista rápida: Labor, Nivel, m³ total, USO, Presión (bar), Observaciones.
      </p>

      <div class="table-wrap">
        <table aria-label="Dashboard de registros">
          <thead>
            <tr>
              <th>Fecha</th><th>Labor</th><th>Nivel</th><th>m³ total</th><th>USO</th><th>Presión (bar)</th><th>Observaciones</th>
            </tr>
          </thead>
          <tbody id="tbody-dashboard">
            <tr class="no-data"><td colspan="7">Sin registros guardados</td></tr>
          </tbody>
        </table>
      </div>

      <!-- Gráfico: Labor vs Presión (bar) -->
      <div class="chart-card">
        <div class="chart-title">Labor vs Presión (bar) — promedio por labor</div>
        <canvas id="chart-presion-labor"></canvas>
      </div>
    </section>

    <div class="footer">
      Fórmula base: <code>m³ = ((((H × 2) + A) × 0.9) × L) / factor</code> — Total: <code>m³ base + frente</code><br>
      © <span id="year"></span> — By Cesar Laura
    </div>
  </main>

  <!-- Registro del Service Worker con scope del repo -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/shotcrete-calc/sw.js', { scope: '/shotcrete-calc/' }).catch(console.error);
      });
    }
  </script>

  <!-- Lógica: tabs (Dashboard en 4ª), cálculo rápido, cálculo completo, registros, dashboard y gráfico Labor/bar -->
  <script>
    const STORAGE_FORM = 'sc_form';
    const STORAGE_REGS = 'sc_registros';
    const STORAGE_TAB  = 'sc_tab_activa';
    const FACTOR_DEF   = 11.5; // factor fijo para Cálculo rápido

    const els = {
      // Rápido
      rA: document.getElementById('r-ancho'),
      rH: document.getElementById('r-altura'),
      rL: document.getElementById('r-largo'),
      rFrente: document.getElementById('r-frente'),
      rMsg: document.getElementById('r-msg'),
      rPanel: document.getElementById('r-panel'),
      rValor: document.getElementById('r-valor'),
      rResumen: document.getElementById('r-resumen'),
      rBtnCalc: document.getElementById('r-btn-calcular'),
      rBtnLimpiar: document.getElementById('r-btn-limpiar'),

      // Completo
      fecha: document.getElementById('fecha'),
      labor: document.getElementById('labor'),
      nivel: document.getElementById('nivel'),
      ancho: document.getElementById('ancho'),
      largo: document.getElementById('largo'),
      altura: document.getElementById('altura'),
      factor: document.getElementById('factor'),
      frente: document.getElementById('frente'),
      presionBar: document.getElementById('presion_bar'),
      guardia: document.getElementById('guardia'),
      uso: document.getElementById('uso'),
      observaciones: document.getElementById('observaciones'),
      msg: document.getElementById('msg'),
      panel: document.getElementById('panel-resultado'),
      valor: document.getElementById('valor-m3'),
      resumen: document.getElementById('resumen'),
      btnCalcular: document.getElementById('btn-calcular'),
      btnGuardar: document.getElementById('btn-guardar'),
      btnLimpiar: document.getElementById('btn-limpiar'),

      // Tabs
      tabRapidoBtn: document.getElementById('tab-rapido-btn'),
      tabIngresoBtn: document.getElementById('tab-ingreso-btn'),
      tabRegistrosBtn: document.getElementById('tab-registros-btn'),
      tabDashboardBtn: document.getElementById('tab-dashboard-btn'),
      tabRapido: document.getElementById('tab-rapido'),
      tabIngreso: document.getElementById('tab-ingreso'),
      tabRegistros: document.getElementById('tab-registros'),
      tabDashboard: document.getElementById('tab-dashboard'),

      // Registros / Dashboard / Chart
      tbody: document.getElementById('tbody-registros'),
      btnCSV: document.getElementById('btn-csv'),
      btnBorrarTodo: document.getElementById('btn-borrar-todo'),
      tbodyDashboard: document.getElementById('tbody-dashboard'),
      chartLaborCanvas: document.getElementById('chart-presion-labor')
    };

    let registros = []; // {id, fecha, labor, nivel, guardia, uso, observaciones, A, L, H, factor, frente, presionBar, m3Base, m3Total}

    /* ====== Tabs (Dashboard en 4ª) ====== */
    function switchTab(name) {
      const rapido     = name === 'rapido';
      const ingreso    = name === 'ingreso';
      const registrosT = name === 'registros';
      const dashboard  = name === 'dashboard';

      els.tabRapido.classList.toggle('active', rapido);
      els.tabIngreso.classList.toggle('active', ingreso);
      els.tabRegistros.classList.toggle('active', registrosT);
      els.tabDashboard.classList.toggle('active', dashboard);

      els.tabRapidoBtn.setAttribute('aria-selected', rapido ? 'true' : 'false');
      els.tabIngresoBtn.setAttribute('aria-selected', ingreso ? 'true' : 'false');
      els.tabRegistrosBtn.setAttribute('aria-selected', registrosT ? 'true' : 'false');
      els.tabDashboardBtn.setAttribute('aria-selected', dashboard ? 'true' : 'false');

      localStorage.setItem(STORAGE_TAB, name);
      if (dashboard) { renderDashboard(); renderLaborChart(); }
    }

    els.tabRapidoBtn.addEventListener('click', () => switchTab('rapido'));
    els.tabIngresoBtn.addEventListener('click', () => switchTab('ingreso'));
    els.tabRegistrosBtn.addEventListener('click', () => switchTab('registros'));
    els.tabDashboardBtn.addEventListener('click', () => switchTab('dashboard'));

    /* ====== Carga inicial ====== */
    window.addEventListener('DOMContentLoaded', () => {
      // Restaurar formulario completo
      const last = JSON.parse(localStorage.getItem(STORAGE_FORM) || '{}');
      Object.entries(last).forEach(([k,v]) => { if (els[k] !== undefined) els[k].value = v; });

      // Cargar registros
      registros = JSON.parse(localStorage.getItem(STORAGE_REGS) || '[]');
      ordenarPorFechaDesc();
      renderTabla();
      renderDashboard();
      renderLaborChart();

      // Tab previa (por defecto: rápido)
      const t = localStorage.getItem(STORAGE_TAB) || 'rapido';
      switchTab(t);
    });

    // Guardar últimos valores del formulario completo
    ['fecha','labor','nivel','ancho','largo','altura','factor','frente','presion_bar','guardia','uso','observaciones'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('input', () => {
        const data = {
          fecha: els.fecha.value, labor: els.labor.value, nivel: els.nivel.value,
          ancho: els.ancho.value, largo: els.largo.value, altura: els.altura.value,
          factor: els.factor.value, frente: els.frente.value,
          presion_bar: els.presionBar.value, guardia: els.guardia.value,
          uso: els.uso.value, observaciones: els.observaciones.value
        };
        localStorage.setItem(STORAGE_FORM, JSON.stringify(data));
      });
    });

    /* ====== Cálculo rápido (factor fijo 11.5) ====== */
    function calcularRapido(){
      els.rMsg.textContent = '';
      const A  = parseFloat(els.rA.value);
      const H  = parseFloat(els.rH.value);
      const L  = parseFloat(els.rL.value);
      const fr = parseFloat(els.rFrente.value || '0');

      if ([A,H,L].some(v => isNaN(v))) {
        els.rPanel.style.display = 'none';
        els.rMsg.textContent = 'Verifica que A, H y L sean números válidos.';
        return;
      }
      if (A < 0 || H < 0 || L <= 0 || (isNaN(fr) || fr < 0)) {
        els.rPanel.style.display = 'none';
        els.rMsg.textContent = 'Valores deben ser positivos; Frente puede ser 0 o mayor.';
        return;
      }

      const m3Base  = ((((H * 2) + A) * 0.9) * L) / FACTOR_DEF;
      const m3Total = m3Base + fr;

      els.rPanel.style.display = 'block';
      els.rValor.textContent = `${m3Total.toFixed(3)} m³`;
      els.rResumen.textContent =
        `m³ base: ${m3Base.toFixed(3)} | Frente: ${fr.toFixed(3)} | Total: ${m3Total.toFixed(3)}\n` +
        `A=${A.toFixed(2)} m, H=${H.toFixed(2)} m, L=${L.toFixed(2)} m • Factor(fijo)=${FACTOR_DEF.toFixed(2)}`;
    }

    function limpiarRapido(){
      ['r-ancho','r-altura','r-largo'].forEach(id => document.getElementById(id).value = '');
      els.rFrente.value = '0';
      els.rMsg.textContent = '';
      els.rPanel.style.display = 'none';
    }

    els.rBtnCalc.addEventListener('click', calcularRapido);
    els.rBtnLimpiar.addEventListener('click', limpiarRapido);

    /* ====== Cálculo completo ====== */
    function calcular(){
      els.msg.textContent = '';
      const labor = els.labor.value.trim();
      const nivel = els.nivel.value.trim();
      const A = parseFloat(els.ancho.value);
      const L = parseFloat(els.largo.value);
      const H = parseFloat(els.altura.value);
      const f = parseFloat(els.factor.value);
      const fr = parseFloat(els.frente.value || '0');
      const prBar = parseFloat(els.presionBar.value || '0');

      if ([A,L,H,f].some(v => isNaN(v))) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Verifica que A, L, H y el factor sean números válidos.';
        return;
      }
      if (A < 0 || H < 0 || L <= 0 || f <= 0 || (isNaN(fr) || fr < 0) || (isNaN(prBar) || prBar < 0)) {
        els.panel.style.display = 'none';
        els.msg.textContent = 'Valores inválidos: A/H ≥ 0, L/factor > 0, frente ≥ 0, presión (bar) ≥ 0.';
        return;
      }

      const m3Base  = ((((H * 2) + A) * 0.9) * L) / f;
      const m3Total = m3Base + fr;

